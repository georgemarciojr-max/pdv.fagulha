<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fagulha Grill - PDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .nav-active {
            color: #1f2937; /* gray-800 */
            background-color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <div id="app" class="h-full flex flex-col">

        <div id="login-view" class="flex flex-col items-center justify-center h-full bg-gray-800 p-4">
            <div class="w-full max-w-sm bg-gray-900 p-8 rounded-2xl shadow-2xl text-center fade-in">
                <i class="fas fa-utensils text-5xl text-amber-400 mb-4"></i>
                <h1 class="text-4xl font-extrabold text-white mb-2">Fagulha Grill</h1>
                <p class="text-gray-400 mb-8">Acesso ao Sistema PDV</p>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700 text-white p-3 rounded-lg border-0" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full bg-gray-700 text-white p-3 rounded-lg border-0" required>
                    <button type="submit" class="w-full text-lg bg-amber-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-amber-700 transition-all duration-300 shadow-lg flex items-center justify-center gap-3">
                        <i class="fas fa-sign-in-alt"></i>Entrar
                    </button>
                </form>
                <p id="login-error" class="text-red-500 text-sm mt-4 h-5"></p>
            </div>
        </div>

        <div id="main-view" class="hidden h-full flex flex-col">
            <header class="bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-center border-b border-gray-700">
                <div>
                    <h1 class="text-2xl font-bold" id="header-title"></h1>
                    <p class="text-xs text-gray-400" id="user-info"></p>
                </div>
                <div id="header-actions" class="flex items-center gap-3">
                    <button onclick="handleLogout()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto" id="main-container"></main>
        </div>
        
        <div id="pdv-view" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col"></div>
        <div id="caixa-detalhe-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="item-details-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="relatorios-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="abrir-caixa-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="gestao-usuarios-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"></div>
        <div id="notification-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, writeBatch, serverTimestamp, updateDoc, query, where, getDoc, orderBy, getDocs, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3rqB_5P8UKl8jTFBTD6L4_jnIPgvTkJA",
            authDomain: "fagula-grill.firebaseapp.com",
            projectId: "fagula-grill",
            storageBucket: "fagula-grill.appspot.com",
            messagingSenderId: "537393387141",
            appId: "1:537393387141:web:1bc57d34575eaa2eb53bec",
            measurementId: "G-LGJBCZGC4C"
        };
        
        const cardapio = { "Espetos Clássicos": [ { id: 'esp-frango', nome: 'Frango', preco: 10.00 }, { id: 'esp-coracao', nome: 'Coração', preco: 10.00 }, { id: 'esp-linguica', nome: 'Linguiça', preco: 10.00 }, { id: 'esp-paoalho', nome: 'Pão de Alho', preco: 10.00 }, { id: 'esp-santamassa', nome: 'Santa Massa', preco: 10.00 }, { id: 'esp-queijo', nome: 'Queijo Coalho', preco: 12.00 }, { id: 'esp-torresmo-espeto', nome: 'Torresmo', preco: 12.00 }, { id: 'esp-kafta', nome: 'Kafta', preco: 12.00 }, { id: 'esp-alcatra', nome: 'Alcatra', preco: 14.00 } ], "Espetos Premium": [ { id: 'prem-costela', nome: 'Costela', preco: 18.00 }, { id: 'prem-picanha', nome: 'Picanha', preco: 18.00, description: 'Maturatta Friboi' }, { id: 'prem-medalhao-alcatra', nome: 'Medalhão de Alcatra', preco: 18.00 }, { id: 'prem-medalhao-palmito', nome: 'Medalhão de Palmito', preco: 18.00 }, { id: 'prem-kafta-queijo', nome: 'Kafta com Queijo', preco: 16.00 }, { id: 'prem-medalhao-frango', nome: 'Medalhão de Frango', preco: 16.00 }, { id: 'prem-romeujulieta', nome: 'Medalhão Romeu e Julieta', preco: 16.00 }, { id: 'prem-almondega', nome: 'Medalhão de Almôndega', preco: 16.00 }, { id: 'prem-vegetariano', nome: 'Vegetariano', preco: 16.00 }, { id: 'prem-mandioca', nome: 'Medalhão de Mandioca', preco: 16.00, description: 'Com carne seca e queijo' } ], "Entradas": [ { id: 'ent-torresmo', nome: 'Torresmo (Individual)', preco: 24.00, description: 'Barrinha de panceta' }, { id: 'ent-bolinho-costela', nome: 'Bolinho de Costela (3und)', preco: 24.00 }, { id: 'ent-pao-kafta', nome: 'Pão de Alho com Kafta e Queijo', preco: 24.00 }, { id: 'ent-porpetone', nome: 'Porpetone', preco: 26.00, description: 'Bolo de carne artesanal recheado com queijo assado na churrasqueira' }, { id: 'ent-salaminho', nome: 'Salaminho (100g)', preco: 18.00 }, { id: 'ent-frios', nome: 'Pratinho de Frios', preco: 39.00, description: 'Salame, mussarela, ovo de codorna e azeitonas' }, { id: 'ent-paolica', nome: 'Pãoliça (Porção Individual)', preco: 19.00, description: 'Massa de linguiça temperada, queijo mussarela e molho verde no pão francês grelhado' } ], "Acompanhamentos": [ { id: 'acomp-trio', nome: 'Trio', preco: 10.00, description: 'Vinagrete, farofa e molho verde' } ], "Bebidas & Cia": [ { id: 'refri-lata', nome: 'Refrigerante Lata', preco: 5.00 }, { id: 'agua-com-gas', nome: 'Água c/ Gás', preco: 4.00 }, { id: 'agua-sem-gas', nome: 'Água s/ Gás', preco: 3.00 }, { id: 'h2oh', nome: 'H2OH!', preco: 6.00 }, { id: 'suco-lata', nome: 'Suco Lata', preco: 6.00 }, { id: 'energetico', nome: 'Energético', preco: 12.00 }, { id: 'heineken-ln', nome: 'Heineken LN', preco: 10.00 }, { id: 'bud-ln', nome: 'Budweiser LN', preco: 9.00 }, { id: 'stella-ln', nome: 'Stella Artois LN', preco: 9.00 }, { id: 'heineken-600', nome: 'Heineken 600ml', preco: 18.00 }, { id: 'original-600', nome: 'Original 600ml', preco: 15.00 }, { id: 'bud-600', nome: 'Budweiser 600ml', preco: 15.00 }, { id: 'suco-jarra', nome: 'Suco Jarra 1L', preco: 15.00 }, { id: 'dose-campari', nome: 'Dose Campari', preco: 10.00 }, { id: 'dose-gin', nome: 'Dose Gin', preco: 15.00 }, { id: 'dose-redlabel', nome: 'Dose Red Label', preco: 15.00 }, { id: 'dose-oldparr', nome: 'Dose Old Parr', preco: 18.00 }, { id: 'drink-gintonica', nome: 'Gin Tônica', preco: 25.00 }, { id: 'drink-caipirinha', nome: 'Caipirinha', preco: 18.00 } ] };

        // Variáveis globais
        let app, auth, db, usuarioLogado, mesaSelecionada, comandaTemporaria = [], listeners = [], synth;
        let caixaStatus = { status: 'fechado' };

        // --- FASE 1: INICIALIZAÇÃO E LÓGICA DE LOGIN ---
        const initFirebase = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                        if (userDoc.exists() && userDoc.data().status === 'ativo') {
                            usuarioLogado = { uid: user.uid, ...userDoc.data() };
                            document.getElementById('login-view').classList.add('hidden');
                            document.getElementById('main-view').classList.remove('hidden');
                            iniciarSistema();
                        } else {
                            handleLogout("Usuário não encontrado ou inativo.");
                        }
                    } else {
                        document.getElementById('login-view').classList.remove('hidden');
                        document.getElementById('main-view').classList.add('hidden');
                        limparTudo();
                    }
                });

                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.body.addEventListener('click', () => { if (!synth) synth = new Tone.Synth().toDestination(); }, { once: true });

            } catch (e) {
                console.error("Erro de inicialização do Firebase:", e);
                document.getElementById('login-error').textContent = 'Erro de configuração do Firebase.';
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged irá lidar com o resto
            } catch (error) {
                console.error("Erro de login:", error.code);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    errorEl.textContent = 'Email ou senha inválidos.';
                } else {
                    errorEl.textContent = 'Erro ao tentar fazer login.';
                }
            }
        };

        const handleLogout = async (msg = '') => {
            if (msg) console.log(msg);
            await signOut(auth);
            limparTudo();
        };

        const limparTudo = () => {
            usuarioLogado = null;
            listeners.forEach(unsub => unsub());
            listeners = [];
            // Limpa qualquer timer
            if (window.cozinhaTimerInterval) clearInterval(window.cozinhaTimerInterval);
            window.cozinhaTimerInterval = null;
        };

        const iniciarSistema = () => {
            document.getElementById('user-info').innerHTML = `Logado como: <strong>${usuarioLogado.nome}</strong> (${usuarioLogado.perfil})`;
            const headerActions = document.getElementById('header-actions');
            // Limpa actions antigas, exceto o botão de sair
            headerActions.querySelectorAll('button:not(:last-child)').forEach(btn => btn.remove());

            // Adiciona botões específicos do perfil
            if (usuarioLogado.perfil === 'caixa') {
                const gestaoBtn = document.createElement('button');
                gestaoBtn.innerHTML = `<i class="fas fa-users-cog mr-2"></i>Gerenciar Usuários`;
                gestaoBtn.className = "bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors";
                gestaoBtn.onclick = abrirGestaoUsuariosView;
                headerActions.prepend(gestaoBtn);
            }

            // Listener para o status do caixa
            listeners.push(onSnapshot(doc(db, "configuracao", "caixa"), (doc) => {
                caixaStatus = doc.exists() ? doc.data() : { status: 'fechado' };
                rotearParaViewPrincipal();
            }));
        };

        const rotearParaViewPrincipal = () => {
            const mainContainer = document.getElementById('main-container');

            if (usuarioLogado.perfil === 'caixa') {
                if (caixaStatus.status === 'aberto') {
                    renderCaixaAbertoView();
                } else {
                    renderCaixaFechadoView();
                }
            } else if (usuarioLogado.perfil === 'atendente') {
                if (caixaStatus.status !== 'aberto') {
                    mainContainer.innerHTML = `<div class="p-8 text-center"><i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold">O Caixa está fechado.</h2><p class="text-gray-400">Aguarde o caixa ser aberto para iniciar os atendimentos.</p></div>`;
                } else {
                    document.getElementById('header-title').textContent = 'Mapa de Mesas';
                    mainContainer.innerHTML = `<div id="mesas-view" class="p-4 sm:p-6"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>`;
                    setupMesasView();
                    setupNotificacaoListener(); 
                }
            } else if (usuarioLogado.perfil === 'cozinha') {
                 if (caixaStatus.status !== 'aberto') {
                    mainContainer.innerHTML = `<div class="p-8 text-center"><i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold">O Caixa está fechado.</h2><p class="text-gray-400">A cozinha opera apenas com o caixa aberto.</p></div>`;
                } else {
                    document.getElementById('header-title').textContent = 'Painel da Cozinha';
                    mainContainer.innerHTML = `<div id="cozinha-view" class="h-full flex flex-col"></div>`;
                    setupCozinhaView();
                }
            }
        };

        const abrirGestaoUsuariosView = async () => {
            const modal = document.getElementById('gestao-usuarios-view');
            modal.classList.remove('hidden');
            modal.innerHTML = `
                <div class="bg-gray-800 w-full max-w-4xl h-auto max-h-[90vh] rounded-2xl shadow-2xl flex flex-col fade-in">
                    <header class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Gestão de Usuários</h2>
                        <button onclick="document.getElementById('gestao-usuarios-view').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
                    </header>
                    <main class="p-6 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg mb-2">Usuários Cadastrados</h3>
                            <div id="lista-usuarios" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">Novo Usuário</h3>
                            <form id="form-novo-usuario" class="space-y-3 bg-gray-700 p-4 rounded-lg">
                                <input type="text" id="novo-nome" placeholder="Nome Completo" class="w-full bg-gray-600 p-2 rounded" required>
                                <input type="email" id="novo-email" placeholder="Email de Login" class="w-full bg-gray-600 p-2 rounded" required>
                                <input type="password" id="novo-senha" placeholder="Senha Provisória" class="w-full bg-gray-600 p-2 rounded" required>
                                <select id="novo-perfil" class="w-full bg-gray-600 p-2 rounded" required>
                                    <option value="" disabled selected>Selecione o Perfil</option>
                                    <option value="atendente">Atendente</option>
                                    <option value="cozinha">Cozinha</option>
                                    <option value="caixa">Caixa</option>
                                </select>
                                <button type="submit" class="w-full bg-green-600 font-bold p-2 rounded hover:bg-green-700">Criar Usuário</button>
                            </form>
                        </div>
                    </main>
                </div>
            `;
            
            document.getElementById('form-novo-usuario').addEventListener('submit', handleCriarUsuario);
            carregarListaUsuarios();
        };

        const carregarListaUsuarios = () => {
            const container = document.getElementById('lista-usuarios');
            if (!container) return;
            container.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Carregando...`;

            const q = query(collection(db, "usuarios"), orderBy("nome"));
            const unsub = onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    container.innerHTML = `<p class="text-gray-400">Nenhum usuário cadastrado.</p>`;
                    return;
                }
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userEl = document.createElement('div');
                    userEl.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    userEl.innerHTML = `
                        <div>
                            <p class="font-bold">${user.nome}</p>
                            <p class="text-sm text-gray-400">${user.email} - <span class="capitalize">${user.perfil}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${user.status === 'ativo' ? 'bg-green-500' : 'bg-red-500'}">${user.status}</span>
                            ${usuarioLogado.uid !== doc.id ? `<button onclick="toggleUserStatus('${doc.id}', '${user.status}')" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded">${user.status === 'ativo' ? 'Desativar' : 'Ativar'}</button>` : ''}
                        </div>
                    `;
                    container.appendChild(userEl);
                });
            });
            listeners.push(unsub); 
        };
        
        const handleCriarUsuario = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('novo-nome').value;
            const email = document.getElementById('novo-email').value;
            const senha = document.getElementById('novo-senha').value;
            const perfil = document.getElementById('novo-perfil').value;

            if (!nome || !email || !senha || !perfil) {
                showNotification("Preencha todos os campos do novo usuário.", "error");
                return;
            }

            const appName = `temp-user-creation-${Date.now()}`;
            const tempApp = initializeApp(firebaseConfig, appName);
            const tempAuth = getAuth(tempApp);
            
            showNotification("Processando criação...", "info");

            try {
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, senha);
                const newUser = userCredential.user;
                await setDoc(doc(db, "usuarios", newUser.uid), { nome, email, perfil, status: 'ativo' });
                await signOut(tempAuth);
                showNotification(`Usuário "${nome}" criado com sucesso!`, "success");
                e.target.reset();
            } catch (error) {
                console.error("Erro ao criar usuário:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showNotification("Este email já está cadastrado no sistema.", "error");
                } else if (error.code === 'auth/weak-password') {
                    showNotification("A senha precisa ter no mínimo 6 caracteres.", "error");
                } else {
                    showNotification("Ocorreu um erro ao criar o usuário.", "error");
                }
            }
        };

        const toggleUserStatus = async (uid, statusAtual) => {
            const novoStatus = statusAtual === 'ativo' ? 'inativo' : 'ativo';
            await updateDoc(doc(db, "usuarios", uid), { status: novoStatus });
            showNotification(`Usuário ${novoStatus === 'ativo' ? 'ativado' : 'desativado'} com sucesso!`, 'success');
        };

        const renderCaixaAbertoView = () => {
            document.getElementById('header-title').textContent = 'Painel do Caixa';
            const headerActions = document.getElementById('header-actions');
            if(!document.getElementById('relatorios-btn')) {
                const relatoriosBtn = document.createElement('button');
                relatoriosBtn.id = 'relatorios-btn';
                relatoriosBtn.innerHTML = `<i class="fas fa-chart-line"></i> Relatórios`;
                relatoriosBtn.className = `bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-500 transition-colors flex items-center gap-2`;
                relatoriosBtn.onclick = abrirRelatoriosView;
                headerActions.prepend(relatoriosBtn);
            }
            if(!document.getElementById('fechar-caixa-btn')) {
                const fecharCaixaBtn = document.createElement('button');
                fecharCaixaBtn.id = 'fechar-caixa-btn';
                fecharCaixaBtn.innerHTML = `<i class="fas fa-door-open"></i> Fechar Caixa`;
                fecharCaixaBtn.className = `bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-500 transition-colors flex items-center gap-2`;
                fecharCaixaBtn.onclick = fecharCaixa;
                headerActions.prepend(fecharCaixaBtn);
            }
            
            document.getElementById('main-container').innerHTML = `<div id="mesas-view" class="p-4 sm:p-6"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>`;
            setupMesasView();
        };

        const fecharConta = async () => {
            // ... (A ser implementado com a nova lógica de auditoria) ...
            showNotification("Função 'Fechar Conta' em desenvolvimento.", "info");
        };

        const abrirDetalheCaixaView = () => {
            // ... (A ser implementado com a nova lógica de cancelamento) ...
            showNotification("Função 'Detalhe Caixa' em desenvolvimento.", "info");
        };

        const cancelarPedidosMesa = async (numeroMesa) => {
            // ... (A ser implementado) ...
            showNotification("Função 'Cancelar Pedido' em desenvolvimento.", "info");
        };

        const enviarPedido = async () => {
            // ... (A ser implementado com a nova lógica de auditoria) ...
            showNotification("Função 'Enviar Pedido' em desenvolvimento.", "info");
        };
        
        const setupCozinhaView = () => {
            // AQUI ENTRA A CORREÇÃO FOCAL DO BUG DA COZINHA
            const container = document.getElementById('cozinha-view');
            container.innerHTML = `
                <div class="h-full flex gap-4 p-4 overflow-x-auto">
                    <div class="bg-gray-800 rounded-lg w-full md:w-1/2 flex-shrink-0 flex flex-col">
                        <h2 class="text-xl font-bold p-3 border-b border-gray-700 text-yellow-400 text-center">A FAZER</h2>
                        <div id="col-pendente" class="p-3 space-y-3 overflow-y-auto flex-1"></div>
                    </div>
                    <div class="bg-gray-800 rounded-lg w-full md:w-1/2 flex-shrink-0 flex flex-col">
                        <h2 class="text-xl font-bold p-3 border-b border-gray-700 text-green-400 text-center">AGUARDANDO RETIRADA</h2>
                        <div id="col-pronto" class="p-3 space-y-3 overflow-y-auto flex-1"></div>
                    </div>
                </div>
            `;
            listenToPedidosCozinha();
        };

        const listenToPedidosCozinha = () => {
            // A CORREÇÃO ESTÁ AQUI: REMOVEMOS O orderBy("criadoEm") DA CONSULTA
            const q = query(collection(db, "pedidos_cozinha"), where("status", "in", ["pendente", "pronto"]));
            
            const unsub = onSnapshot(q, (snapshot) => {
                const colPendente = document.getElementById('col-pendente');
                const colPronto = document.getElementById('col-pronto');
                if(!colPendente || !colPronto) return;

                snapshot.docChanges().forEach(change => {
                    const pedido = { id: change.doc.id, ...change.doc.data() };
                    const cardId = `pedido-${pedido.id}`;
                    const existingCard = document.getElementById(cardId);

                    if (change.type === "removed" || pedido.status === 'entregue' || pedido.status === 'cancelado') {
                        if (existingCard) existingCard.remove();
                    } else { // added or modified
                        if (existingCard) existingCard.remove();
                        
                        if (pedido.status === 'pendente') {
                            colPendente.appendChild(createPedidoCard(pedido));
                        } else if (pedido.status === 'pronto') {
                            colPronto.appendChild(createPedidoCard(pedido));
                        }
                    }

                    if (change.type === "added" && pedido.status === 'pendente' && synth) {
                        synth.triggerAttackRelease("C5", "0.5");
                    }
                });
                
                // Ordena os cards dentro de cada coluna após as atualizações
                sortCards(colPendente);
                sortCards(colPronto);
                
                if (colPendente.children.length === 0) colPendente.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum pedido pendente.</p>`;
                if (colPronto.children.length === 0) colPronto.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum pedido pronto.</p>`;

                if (!window.cozinhaTimerInterval) {
                   window.cozinhaTimerInterval = setInterval(updateTimers, 1000);
                }
            });
            listeners.push(unsub);
        };
        
        const sortCards = (container) => {
            const cards = Array.from(container.children);
            if(cards.length > 1 && cards[0].dataset) {
                cards.sort((a, b) => (a.dataset.timestamp || 0) - (b.dataset.timestamp || 0));
                cards.forEach(card => container.appendChild(card));
            }
        };

        const createPedidoCard = (pedido) => {
            const card = document.createElement('div');
            card.id = `pedido-${pedido.id}`;
            card.dataset.timestamp = pedido.criadoEm?.seconds || 0;
            card.className = 'bg-gray-900 p-3 rounded-lg shadow-lg flex flex-col gap-2 fade-in';
            
            let actionButton;
            if(pedido.status === 'pendente') {
                actionButton = `<button onclick="marcarPedidoPronto('${pedido.id}')" class="w-full mt-2 bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">Pronto</button>`;
            } else {
                actionButton = `<button onclick="marcarPedidoEntregue('${pedido.id}')" class="w-full mt-2 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Entregue</button>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-center pb-1 border-b border-gray-700">
                    <h3 class="text-lg font-extrabold text-amber-400">Mesa ${pedido.mesa}</h3>
                    <span class="text-xs font-bold" data-timestamp="${pedido.criadoEm?.seconds}">00:00</span>
                </div>
                <p class="text-xs text-gray-400">Por: ${pedido.lancadoPor?.nome || 'N/A'}</p>
                <p class="text-sm">${pedido.itens.map(i => `${i.quantidade}x ${i.nome}`).join(', ')}</p>
                ${actionButton}
            `;
            return card;
        };
        
        const marcarPedidoPronto = id => updateDoc(doc(db, "pedidos_cozinha", id), { status: 'pronto' });
        const marcarPedidoEntregue = id => updateDoc(doc(db, "pedidos_cozinha", id), { status: 'entregue' });

        const setupNotificacaoListener = () => { /* ... (código idêntico ao anterior) ... */ };
        
        const showNotification = (message, type = 'success', duration = 3000) => { /* ... (código idêntico ao anterior) ... */ };
        const renderCaixaFechadoView = () => { /* ... (código idêntico ao anterior) ... */ };
        const abrirModalAberturaCaixa = () => { /* ... (código idêntico ao anterior) ... */ };
        const abrirCaixa = async () => { /* ... (código idêntico ao anterior) ... */ };
        const fecharCaixa = async () => { /* ... (código idêntico ao anterior) ... */ };
        const setupMesasView = () => { /* ... (código idêntico ao anterior) ... */ };
        const updateMesaCard = (numero, data) => { /* ... (código idêntico ao anterior) ... */ };
        const handleMesaClick = async (numero, data) => { /* ... (código idêntico ao anterior) ... */ };
        const abrirPdvView = async (numero) => { /* ... (código idêntico ao anterior) ... */ };
        const fecharPdvView = () => { /* ... (código idêntico ao anterior) ... */ };
        const renderPdvScreen = (screen) => { /* ... (código idêntico ao anterior) ... */ };
        const renderCategorias = () => { /* ... (código idêntico ao anterior) ... */ };
        const renderProdutos = (cat) => { /* ... (código idêntico ao anterior) ... */ };
        const abrirDetalhesItem = (item) => { /* ... (código idêntico ao anterior) ... */ };
        const fecharDetalhesItem = () => document.getElementById('item-details-view').classList.add('hidden');
        const renderComanda = () => { /* ... (código idêntico ao anterior) ... */ };
        const changeQty = (i, amount) => { /* ... (código idêntico ao anterior) ... */ };
        const updateTimers = () => { /* ... (código idêntico ao anterior) ... */ };
        const abrirRelatoriosView = async () => { /* ... (código idêntico ao anterior) ... */ };
        const fecharRelatoriosView = () => document.getElementById('relatorios-view').classList.add('hidden');
        const fecharDetalheCaixaView = () => document.getElementById('caixa-detalhe-view').classList.add('hidden');
        const formatCurrency = v => v ? v.toLocaleString('pt-BR', { style: 'currency', 'currency': 'BRL' }) : 'R$ 0,00';

        window.handleLogout = handleLogout; window.abrirGestaoUsuariosView = abrirGestaoUsuariosView; window.toggleUserStatus = toggleUserStatus; window.fecharConta = fecharConta; window.cancelarPedidosMesa = cancelarPedidosMesa; window.marcarPedidoPronto = marcarPedidoPronto; window.marcarPedidoEntregue = marcarPedidoEntregue; window.abrirModalAberturaCaixa=abrirModalAberturaCaixa; window.abrirCaixa=abrirCaixa; window.fecharCaixa=fecharCaixa; window.fecharPdvView=fecharPdvView; window.renderPdvScreen=renderPdvScreen; window.enviarPedido=enviarPedido; window.changeQty=changeQty; window.fecharDetalhesItem=fecharDetalhesItem; window.fecharDetalheCaixaView=fecharDetalheCaixaView; window.handleCriarUsuario = handleCriarUsuario;
        
        initFirebase();
    </script>
</body>
</html>

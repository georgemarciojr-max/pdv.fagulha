<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fagula Grill - PDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .nav-active { color: #f59e0b; } /* Cor âmbar para o ícone ativo */
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <div id="app" class="h-full flex flex-col">

        <!-- TELA DE SELEÇÃO DE PERFIL -->
        <div id="perfil-view" class="flex flex-col items-center justify-center h-full bg-gray-800 p-4 fade-in">
            <div class="w-full max-w-sm bg-gray-900 p-8 rounded-2xl shadow-2xl text-center">
                <i class="fas fa-utensils text-5xl text-amber-400 mb-4"></i>
                <h1 class="text-4xl font-extrabold text-white mb-2">Fagula Grill</h1>
                <p class="text-gray-400 mb-8">Selecione seu perfil para iniciar</p>
                <div class="space-y-4">
                    <button onclick="selecionarPerfil('caixa')" class="w-full text-lg bg-blue-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-lg flex items-center justify-center gap-3 disabled:opacity-50" disabled><i class="fas fa-cash-register"></i>Caixa</button>
                    <button onclick="selecionarPerfil('atendente')" class="w-full text-lg bg-green-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-green-700 transition-all duration-300 shadow-lg flex items-center justify-center gap-3 disabled:opacity-50" disabled><i class="fas fa-user-tie"></i>Atendente</button>
                    <button onclick="selecionarPerfil('cozinha')" class="w-full text-lg bg-orange-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-orange-700 transition-all duration-300 shadow-lg flex items-center justify-center gap-3 disabled:opacity-50" disabled><i class="fas fa-fire-burner"></i>Cozinha</button>
                </div>
                <p id="connecting-status" class="text-gray-500 text-sm mt-6">Conectando ao sistema...</p>
            </div>
        </div>

        <!-- CONTEÚDO PRINCIPAL -->
        <div id="main-view" class="hidden h-full flex flex-col">
            <header class="bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-center border-b border-gray-700">
                <div><h1 class="text-2xl font-bold" id="header-title"></h1></div>
                <button onclick="voltarParaPerfis()" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"><i class="fas fa-exchange-alt mr-2"></i>Trocar Perfil</button>
            </header>
            <main class="flex-1 overflow-y-auto p-4 sm:p-6">
                <div id="mesas-view" class="hidden"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>
                <div id="cozinha-view" class="hidden"><div id="pedidos-cozinha-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></div>
            </main>
        </div>
        
        <!-- MODAL PDV (AGORA UM CONTAINER) -->
        <div id="pdv-view" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col">
            <!-- O conteúdo do PDV (Cardápio ou Conta) será injetado aqui -->
        </div>

        <!-- MODAL DETALHE CAIXA -->
        <div id="caixa-detalhe-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        
        <!-- NOTIFICAÇÃO -->
        <div id="notification" class="hidden fixed bottom-20 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl"><p></p></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, writeBatch, serverTimestamp, updateDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // SUA CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyA3rqB_5P8UKl8jTFBTD6L4_jnIPgvTkJA",
            authDomain: "fagula-grill.firebaseapp.com",
            projectId: "fagula-grill",
            storageBucket: "fagula-grill.firebasestorage.app",
            messagingSenderId: "537393387141",
            appId: "1:537393387141:web:1bc57d34575eaa2eb53bec",
            measurementId: "G-LGJBCZGC4C"
        };
        
        const cardapio = { "Espetos": [{ id: 'esp-carne', nome: 'Carne', preco: 7.00 }, { id: 'esp-coracao', nome: 'Coração', preco: 6.00 }, { id: 'esp-misto', nome: 'Misto', preco: 7.00 }, { id: 'esp-frango', nome: 'Frango', preco: 6.00 }, { id: 'esp-frangobacon', nome: 'Frango c/ Bacon', preco: 8.00 }, { id: 'esp-calabresa', nome: 'Calabresa', preco: 6.00 }, { id: 'esp-queijo', nome: 'Queijo Coalho', preco: 6.00 }, { id: 'esp-tulipa', nome: 'Tulipa', preco: 8.00 }], "Espetos Premium": [{ id: 'prem-filebacon', nome: 'Filé c/ Bacon', preco: 15.00 }, { id: 'prem-picanha', nome: 'Picanha', preco: 18.00 }], "Entradas": [{ id: 'batata-p', nome: 'Batata Frita P', preco: 15.00 }, { id: 'batata-g', nome: 'Batata Frita G', preco: 25.00 }, { id: 'batata-cheddarbacon', nome: 'Batata c/ Cheddar & Bacon', preco: 30.00 }, { id: 'aneis-cebola', nome: 'Anéis de Cebola (12un)', preco: 18.00 }], "Frango Frito": [{ id: 'frango-p', nome: 'Balde P (400g)', preco: 25.00 }, { id: 'frango-m', nome: 'Balde M (600g)', preco: 35.00 }, { id: 'frango-g', nome: 'Balde G (1kg)', preco: 55.00 }], "Hambúrgueres": [{ id: 'burg-classic', nome: 'Classic Burger', preco: 20.00 }, { id: 'burg-salad', nome: 'Salad Burger', preco: 22.00 }, { id: 'burg-bacon', nome: 'Bacon Burger', preco: 25.00 }, { id: 'burg-urban', nome: 'Urban Norte Burger', preco: 30.00 }], "Combos": [{ id: 'combo-classic', nome: 'Combo Classic', preco: 30.00 }, { id: 'combo-salad', nome: 'Combo Salad', preco: 32.00 }, { id: 'combo-bacon', nome: 'Combo Bacon', preco: 35.00 }], "Bebidas": [{ id: 'refri-lata', nome: 'Refrigerante Lata', preco: 5.00 }, { id: 'agua-com-gas', nome: 'Água c/ Gás', preco: 4.00 }, { id: 'agua-sem-gas', nome: 'Água s/ Gás', preco: 3.00 }, { id: 'h2oh', nome: 'H2OH!', preco: 6.00 }, { id: 'suco-lata', nome: 'Suco Lata', preco: 6.00 }, { id: 'energetico', nome: 'Energético', preco: 12.00 }], "Cervejas": [{ id: 'heineken-ln', nome: 'Heineken LN', preco: 10.00 }, { id: 'bud-ln', nome: 'Budweiser LN', preco: 9.00 }, { id: 'stella-ln', nome: 'Stella Artois LN', preco: 9.00 }, { id: 'heineken-600', nome: 'Heineken 600ml', preco: 18.00 }, { id: 'original-600', nome: 'Original 600ml', preco: 15.00 }, { id: 'bud-600', nome: 'Budweiser 600ml', preco: 15.00 }], "Sucos & Doses": [{ id: 'suco-jarra', nome: 'Suco Jarra 1L', preco: 15.00 }, { id: 'dose-campari', nome: 'Dose Campari', preco: 10.00 }, { id: 'dose-gin', nome: 'Dose Gin', preco: 15.00 }, { id: 'dose-redlabel', nome: 'Dose Red Label', preco: 15.00 }, { id: 'dose-oldparr', nome: 'Dose Old Parr', preco: 18.00 }], "Drinks": [{ id: 'drink-gintonica', nome: 'Gin Tônica', preco: 25.00 }, { id: 'drink-caipirinha', nome: 'Caipirinha', preco: 18.00 }] };

        let app, auth, db, perfilAtual, mesaSelecionada, comandaTemporaria = [], listeners = [], synth;

        const initFirebase = async () => { /* ...código idêntico ao anterior... */ };
        
        const selecionarPerfil = p => { /* ...código idêntico ao anterior... */ };

        const voltarParaPerfis = () => {
            perfilAtual = null;
            document.getElementById('perfil-view').classList.remove('hidden');
            document.getElementById('main-view').classList.add('hidden');
            listeners.forEach(unsub => unsub()); listeners = [];
            fecharPdvView(); fecharDetalheCaixaView();
        };

        const setupMesasView = () => { /* ...código idêntico ao anterior... */ };
        const updateMesaCard = (numero, data) => { /* ...código idêntico ao anterior... */ };

        const handleMesaClick = async (numero, data) => {
            if (perfilAtual === 'atendente') {
                abrirPdvView(numero);
            } else if (perfilAtual === 'caixa' && data.status === 'ocupada') {
                mesaSelecionada = { numero, ...data };
                abrirDetalheCaixaView();
            }
        };

        // --- NOVA LÓGICA DO PDV ---
        const abrirPdvView = async (numero) => {
            const mesaDoc = await getDoc(doc(db, "mesas", String(numero)));
            mesaSelecionada = { numero, ...mesaDoc.data() };
            comandaTemporaria = mesaSelecionada.itens ? JSON.parse(JSON.stringify(mesaSelecionada.itens)) : [];
            document.getElementById('pdv-view').classList.remove('hidden');
            renderPdvScreen('editar'); // Abre na tela de edição por padrão
        };

        const fecharPdvView = () => {
            document.getElementById('pdv-view').classList.add('hidden');
            document.getElementById('pdv-view').innerHTML = ''; // Limpa o conteúdo
        };
        
        const renderPdvScreen = (screen) => {
            const container = document.getElementById('pdv-view');
            const totalItens = comandaTemporaria.reduce((acc, item) => acc + item.quantidade, 0);

            let screenHtml = `
                <header class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0 bg-gray-800">
                    <h2 class="text-2xl font-bold">Mesa ${mesaSelecionada.numero}</h2>
                    <div class="relative">
                        <i class="fas fa-shopping-cart text-2xl"></i>
                        ${totalItens > 0 ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${totalItens}</span>` : ''}
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto bg-gray-900">
                    <!-- Conteúdo dinâmico da tela -->
                </main>
                <footer class="flex-shrink-0 bg-gray-800 border-t border-gray-700 grid grid-cols-3 text-center text-gray-400">
                    <button onclick="renderPdvScreen('conta')" class="p-4 ${screen === 'conta' ? 'nav-active' : ''}"><i class="fas fa-receipt text-2xl"></i><span class="text-xs block mt-1">Ver Conta</span></button>
                    <button onclick="renderPdvScreen('editar')" class="p-4 ${screen === 'editar' ? 'nav-active' : ''}"><i class="fas fa-pen-to-square text-2xl"></i><span class="text-xs block mt-1">Editar Pedido</span></button>
                    <button onclick="fecharPdvView()" class="p-4"><i class="fas fa-table-cells text-2xl"></i><span class="text-xs block mt-1">Mesas</span></button>
                </footer>
            `;
            container.innerHTML = screenHtml;

            const mainContainer = container.querySelector('main');
            if (screen === 'editar') {
                mainContainer.innerHTML = `
                    <div class="p-3 border-b border-gray-700 flex-shrink-0 bg-gray-800 sticky top-0"><div id="categorias-container" class="flex items-center gap-2 overflow-x-auto no-scrollbar"></div></div>
                    <div id="produtos-container" class="p-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                `;
                renderCategorias(); 
                renderProdutos(Object.keys(cardapio)[0]);
            } else if (screen === 'conta') {
                mainContainer.innerHTML = `
                    <div class="p-4 flex flex-col h-full">
                        <h3 class="text-xl font-semibold mb-4 flex-shrink-0">Comanda da Mesa</h3>
                        <div id="comanda-itens" class="flex-1 space-y-2 overflow-y-auto no-scrollbar pr-2 mb-4"></div>
                        <div class="border-t border-gray-700 pt-4 flex-shrink-0">
                            <div class="flex justify-between items-center text-2xl font-bold mb-4"><span>Total</span><span id="comanda-total">R$ 0,00</span></div>
                            <button onclick="enviarPedido()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-lg flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> Enviar para Cozinha</button>
                        </div>
                    </div>
                `;
                renderComanda();
            }
        };

        const renderCategorias = () => { /* ...código idêntico ao anterior... */ };
        const renderProdutos = (categoria) => { /* ...código idêntico ao anterior... */ };
        
        const adicionarItem = (item) => {
            const itemExistente = comandaTemporaria.find(i => i.id === item.id);
            if (itemExistente) itemExistente.quantidade++;
            else comandaTemporaria.push({ ...item, quantidade: 1 });
            // Atualiza o contador do carrinho sem recarregar a tela inteira
            const totalItens = comandaTemporaria.reduce((acc, item) => acc + item.quantidade, 0);
            const cartBadge = document.querySelector('#pdv-view header .relative span');
            if (cartBadge) {
                cartBadge.textContent = totalItens;
            } else if (totalItens > 0) {
                 document.querySelector('#pdv-view header .relative').innerHTML += `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${totalItens}</span>`;
            }
            showNotification(`${item.nome} adicionado!`);
        };
        
        const changeQty = (itemId, amount) => { /* ...código idêntico ao anterior... */ renderComanda(); };
        const renderComanda = () => { /* ...código idêntico ao anterior... */ };

        const enviarPedido = async () => { /* ...código idêntico ao anterior... */ };
        const setupCozinhaView = () => { /* ...código idêntico ao anterior... */ };
        const marcarPedidoPronto = async id => { /* ...código idêntico ao anterior... */ };
        const abrirDetalheCaixaView = () => { /* ...código idêntico ao anterior... */ };
        const fecharDetalheCaixaView = () => { /* ...código idêntico ao anterior... */ };
        const fecharConta = async () => { /* ...código idêntico ao anterior... */ };

        const showNotification = (message, type = 'success') => { /* ...código idêntico ao anterior... */ };
        const formatCurrency = v => v.toLocaleString('pt-BR', { style: 'currency', 'currency': 'BRL' });
        
        // ATRIBUIÇÃO GLOBAL DAS FUNÇÕES
        window.selecionarPerfil = selecionarPerfil; window.voltarParaPerfis = voltarParaPerfis; window.fecharPdvView = fecharPdvView; window.changeQty = changeQty; window.enviarPedido = enviarPedido; window.marcarPedidoPronto = marcarPedidoPronto; window.fecharDetalheCaixaView = fecharDetalheCaixaView; window.fecharConta = fecharConta; window.renderPdvScreen = renderPdvScreen;
        
        initFirebase();
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fagulha Grill - PDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .nav-active {
            color: #1f2937; /* gray-800 */
            background-color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <div id="app" class="h-full flex flex-col">

        <div id="login-view" class="flex flex-col items-center justify-center h-full bg-gray-800 p-4">
            <div class="w-full max-w-sm bg-gray-900 p-8 rounded-2xl shadow-2xl">
                <div class="text-center mb-8">
                    <i class="fas fa-utensils text-5xl text-amber-400 mb-4"></i>
                    <h1 class="text-4xl font-extrabold text-white">Fagulha Grill</h1>
                    <p class="text-gray-400 mt-2">Acesso ao Sistema</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="text-sm font-bold text-gray-400">Email</label>
                        <input type="email" id="email" required class="w-full mt-1 bg-gray-700 text-white p-3 rounded-lg border-2 border-transparent focus:border-amber-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-bold text-gray-400">Senha</label>
                        <input type="password" id="password" required class="w-full mt-1 bg-gray-700 text-white p-3 rounded-lg border-2 border-transparent focus:border-amber-500 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full text-lg bg-amber-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-amber-700 transition-all duration-300 shadow-lg">Entrar</button>
                </form>
                <p id="login-status" class="text-center text-red-500 text-sm mt-4 h-5"></p>
            </div>
        </div>

        <div id="main-view" class="hidden h-full flex flex-col">
            <header class="bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-center border-b border-gray-700">
                <div><h1 class="text-2xl font-bold" id="header-title"></h1></div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p id="user-name" class="font-semibold"></p>
                        <p id="user-profile" class="text-xs text-amber-400 capitalize"></p>
                    </div>
                    <div id="header-actions" class="flex items-center gap-3"></div>
                    <button onclick="logout()" title="Sair do sistema" class="bg-red-600 text-white font-bold h-10 w-10 rounded-lg hover:bg-red-500 transition-colors flex items-center justify-center"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto" id="main-container">
                </main>
        </div>
        
        <div id="pdv-view" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col"></div>
        <div id="caixa-detalhe-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="item-details-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="relatorios-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="abrir-caixa-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="usuarios-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="notification" class="hidden fixed bottom-20 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl"><p></p></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, writeBatch, serverTimestamp, updateDoc, query, where, getDoc, orderBy, limit, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3rqB_5P8UKl8jTFBTD6L4_jnIPgvTkJA",
            authDomain: "fagula-grill.firebaseapp.com",
            projectId: "fagula-grill",
            storageBucket: "fagula-grill.firebasestorage.app",
            messagingSenderId: "537393387141",
            appId: "1:537393387141:web:1bc57d34575eaa2eb53bec",
            measurementId: "G-LGJBCZGC4C"
        };
        const cardapio = { "Espetos Clássicos": [ { id: 'esp-frango', nome: 'Frango', preco: 10.00 }, { id: 'esp-coracao', nome: 'Coração', preco: 10.00 }, { id: 'esp-linguica', nome: 'Linguiça', preco: 10.00 }, { id: 'esp-paoalho', nome: 'Pão de Alho', preco: 10.00 }, { id: 'esp-santamassa', nome: 'Santa Massa', preco: 10.00 }, { id: 'esp-queijo', nome: 'Queijo Coalho', preco: 12.00 }, { id: 'esp-torresmo-espeto', nome: 'Torresmo', preco: 12.00 }, { id: 'esp-kafta', nome: 'Kafta', preco: 12.00 }, { id: 'esp-alcatra', nome: 'Alcatra', preco: 14.00 } ], "Espetos Premium": [ { id: 'prem-costela', nome: 'Costela', preco: 18.00 }, { id: 'prem-picanha', nome: 'Picanha', preco: 18.00, description: 'Maturatta Friboi' }, { id: 'prem-medalhao-alcatra', nome: 'Medalhão de Alcatra', preco: 18.00 }, { id: 'prem-medalhao-palmito', nome: 'Medalhão de Palmito', preco: 18.00 }, { id: 'prem-kafta-queijo', nome: 'Kafta com Queijo', preco: 16.00 }, { id: 'prem-medalhao-frango', nome: 'Medalhão de Frango', preco: 16.00 }, { id: 'prem-romeujulieta', nome: 'Medalhão Romeu e Julieta', preco: 16.00 }, { id: 'prem-almondega', nome: 'Medalhão de Almôndega', preco: 16.00 }, { id: 'prem-vegetariano', nome: 'Vegetariano', preco: 16.00 }, { id: 'prem-mandioca', nome: 'Medalhão de Mandioca', preco: 16.00, description: 'Com carne seca e queijo' } ], "Entradas": [ { id: 'ent-torresmo', nome: 'Torresmo (Individual)', preco: 24.00, description: 'Barrinha de panceta' }, { id: 'ent-bolinho-costela', nome: 'Bolinho de Costela (3und)', preco: 24.00 }, { id: 'ent-pao-kafta', nome: 'Pão de Alho com Kafta e Queijo', preco: 24.00 }, { id: 'ent-porpetone', nome: 'Porpetone', preco: 26.00, description: 'Bolo de carne artesanal recheado com queijo assado na churrasqueira' }, { id: 'ent-salaminho', nome: 'Salaminho (100g)', preco: 18.00 }, { id: 'ent-frios', nome: 'Pratinho de Frios', preco: 39.00, description: 'Salame, mussarela, ovo de codorna e azeitonas' }, { id: 'ent-paolica', nome: 'Pãoliça (Porção Individual)', preco: 19.00, description: 'Massa de linguiça temperada, queijo mussarela e molho verde no pão francês grelhado' } ], "Acompanhamentos": [ { id: 'acomp-trio', nome: 'Trio', preco: 10.00, description: 'Vinagrete, farofa e molho verde' } ], "Bebidas & Cia": [ { id: 'refri-lata', nome: 'Refrigerante Lata', preco: 5.00 }, { id: 'agua-com-gas', nome: 'Água c/ Gás', preco: 4.00 }, { id: 'agua-sem-gas', nome: 'Água s/ Gás', preco: 3.00 }, { id: 'h2oh', nome: 'H2OH!', preco: 6.00 }, { id: 'suco-lata', nome: 'Suco Lata', preco: 6.00 }, { id: 'energetico', nome: 'Energético', preco: 12.00 }, { id: 'heineken-ln', nome: 'Heineken LN', preco: 10.00 }, { id: 'bud-ln', nome: 'Budweiser LN', preco: 9.00 }, { id: 'stella-ln', nome: 'Stella Artois LN', preco: 9.00 }, { id: 'heineken-600', nome: 'Heineken 600ml', preco: 18.00 }, { id: 'original-600', nome: 'Original 600ml', preco: 15.00 }, { id: 'bud-600', nome: 'Budweiser 600ml', preco: 15.00 }, { id: 'suco-jarra', nome: 'Suco Jarra 1L', preco: 15.00 }, { id: 'dose-campari', nome: 'Dose Campari', preco: 10.00 }, { id: 'dose-gin', nome: 'Dose Gin', preco: 15.00 }, { id: 'dose-redlabel', nome: 'Dose Red Label', preco: 15.00 }, { id: 'dose-oldparr', nome: 'Dose Old Parr', preco: 18.00 }, { id: 'drink-gintonica', nome: 'Gin Tônica', preco: 25.00 }, { id: 'drink-caipirinha', nome: 'Caipirinha', preco: 18.00 } ] };
        
        let app, auth, db, currentUser = null, mesaSelecionada, comandaTemporaria = [], listeners = [], synth;
        let caixaStatus = { status: 'fechado' };
        let caixaStatusListener = null;

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        const initFirebase = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthObserver();
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.body.addEventListener('click', () => { if (!synth) synth = new Tone.Synth().toDestination(); }, { once: true });
            } catch (e) {
                console.error("Erro de inicialização do Firebase:", e);
                document.getElementById('login-status').textContent = 'Erro de Configuração.';
            }
        };

        const setupAuthObserver = () => {
            onAuthStateChanged(auth, async user => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                    if (userDoc.exists()) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        if(currentUser.status !== 'ativo') {
                            showNotification('Seu usuário está inativo.', 'error');
                            logout();
                            return;
                        }
                        showMainView();
                    } else {
                        const usuariosCollection = await getDocs(collection(db, "usuarios"));
                        if (usuariosCollection.empty) {
                            await createInitialAdmin(user);
                        } else {
                            showNotification('Usuário não encontrado na base de dados.', 'error');
                            logout();
                        }
                    }
                } else {
                    currentUser = null;
                    showLoginView();
                }
            });
        };
        
        const createInitialAdmin = async (user) => {
            const nome = prompt("Bem-vindo! Parece ser o primeiro acesso ao sistema. Digite seu nome para criar a conta de Administrador (Caixa):");
            if(nome && nome.trim() !== "") {
                const adminProfile = {
                    nome: nome,
                    email: user.email,
                    perfil: 'caixa',
                    status: 'ativo',
                    criadoEm: serverTimestamp()
                };
                await setDoc(doc(db, "usuarios", user.uid), adminProfile);
                currentUser = { uid: user.uid, ...adminProfile };
                showNotification('Conta de Administrador criada com sucesso!', 'success');
                showMainView();
            } else {
                showNotification('A criação do admin foi cancelada.', 'error');
                logout();
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('login-status');
            statusEl.textContent = 'Autenticando...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                statusEl.textContent = '';
            } catch (error) {
                if(error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                    const usuariosCollection = await getDocs(collection(db, "usuarios"));
                    if(usuariosCollection.empty){
                       if(confirm("Nenhum usuário encontrado no sistema. Deseja criar este login como a primeira conta de Administrador?")){
                           try {
                               await createUserWithEmailAndPassword(auth, email, password);
                           } catch (createError) {
                               statusEl.textContent = 'Erro ao criar conta. Verifique a senha (mínimo 6 caracteres).';
                           }
                       } else {
                           statusEl.textContent = 'Login cancelado.';
                       }
                    } else {
                       statusEl.textContent = 'Email ou senha inválidos.';
                    }
                } else {
                    statusEl.textContent = 'Erro ao fazer login.';
                    console.error("Erro de Login:", error);
                }
            }
        };

        const logout = () => {
            signOut(auth);
            listeners.forEach(unsub => unsub()); listeners = [];
            if (caixaStatusListener) {
                caixaStatusListener();
                caixaStatusListener = null;
            }
            const timerInterval = window.cozinhaTimerInterval;
            if (timerInterval) clearInterval(timerInterval);
        };

        // --- CONTROLE DE VISUALIZAÇÃO (VIEWS) ---
        const showLoginView = () => {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('main-view').classList.add('hidden');
        };

        const showMainView = () => {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('main-view').classList.add('fade-in');

            document.getElementById('user-name').textContent = currentUser.nome;
            document.getElementById('user-profile').textContent = currentUser.perfil;
            
            listenToCaixaStatus();
            loadProfileView(); 
        };

        const loadProfileView = () => {
            const { perfil } = currentUser;
            document.getElementById('header-actions').innerHTML = '';

            if ((perfil === 'atendente' || perfil === 'cozinha') && caixaStatus.status !== 'aberto') {
                document.getElementById('main-container').innerHTML = `<div class="p-8 text-center"><i class="fas fa-door-closed text-6xl text-gray-500 mb-4"></i><h2 class="text-3xl font-bold">O caixa está fechado.</h2><p class="text-gray-400">Aguarde o gerente abrir o caixa para iniciar.</p></div>`;
                document.getElementById('header-title').textContent = "Sistema Bloqueado";
                return;
            }
            
            setupHeader();
            
            if (perfil === 'caixa') {
                 if (caixaStatus.status === 'aberto') renderCaixaAbertoView();
                 else renderCaixaFechadoView();
            } else if (perfil === 'atendente') {
                renderAtendenteView();
            } else if (perfil === 'cozinha') {
                renderCozinhaView();
            }
        };

        const setupHeader = () => {
            const headerActions = document.getElementById('header-actions');
            headerActions.innerHTML = '';
            if (currentUser.perfil === 'caixa') {
                const btn = document.createElement('button');
                btn.className = 'bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-500 transition-colors flex items-center gap-2';
                btn.innerHTML = `<i class="fas fa-users"></i> Usuários`;
                btn.onclick = abrirUsuariosView;
                headerActions.appendChild(btn);
            }
        };

        const listenToCaixaStatus = () => {
            if (caixaStatusListener) return;
            caixaStatusListener = onSnapshot(doc(db, "configuracao", "caixa"), (doc) => {
                const oldStatus = caixaStatus.status;
                if (doc.exists()) {
                    caixaStatus = doc.data();
                } else {
                    caixaStatus = { status: 'fechado' };
                }
                if (oldStatus !== caixaStatus.status && currentUser) {
                     loadProfileView();
                }
            });
        };
        
        // --- SEÇÕES DE RENDERIZAÇÃO DE PERFIS ---
        const renderCaixaFechadoView = () => {
            document.getElementById('header-title').textContent = 'Caixa Fechado';
            document.getElementById('main-container').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-4">
                    <i class="fas fa-door-closed text-7xl text-gray-500 mb-6"></i>
                    <h2 class="text-4xl font-extrabold mb-2">O Caixa está Fechado</h2>
                    <p class="text-gray-400 mb-8">Abra o caixa para iniciar as operações do dia.</p>
                    <button onclick="abrirModalAberturaCaixa()" class="bg-green-600 text-white font-bold py-4 px-8 rounded-xl text-xl hover:bg-green-700 transition-colors shadow-lg flex items-center gap-3">
                        <i class="fas fa-cash-register"></i> Abrir Caixa
                    </button>
                </div>
            `;
        };

        const renderCaixaAbertoView = () => {
            document.getElementById('header-title').textContent = 'Painel do Caixa';
            const headerActions = document.getElementById('header-actions');
            setupHeader();

            const createButton = (id, icon, text, color, onClick) => {
                if(document.getElementById(id)) return;
                const btn = document.createElement('button');
                btn.id = id;
                btn.className = `bg-${color}-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-${color}-500 transition-colors flex items-center gap-2`;
                btn.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
                btn.onclick = onClick;
                return btn;
            };

            const relatoriosBtn = createButton('relatorios-btn', 'fa-chart-line', 'Relatórios', 'indigo', abrirRelatoriosView);
            const fecharCaixaBtn = createButton('fechar-caixa-btn', 'fa-door-open', 'Fechar Caixa', 'red', fecharCaixa);
            
            if(relatoriosBtn) headerActions.prepend(relatoriosBtn);
            if(fecharCaixaBtn) headerActions.prepend(fecharCaixaBtn);

            document.getElementById('main-container').innerHTML = `<div id="mesas-view" class="p-4 sm:p-6"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>`;
            setupMesasView();
        };

        const renderAtendenteView = () => {
            document.getElementById('header-title').textContent = 'Mapa de Mesas';
            document.getElementById('main-container').innerHTML = `<div id="mesas-view" class="p-4 sm:p-6"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>`;
            setupMesasView();
        };

        const renderCozinhaView = () => {
            document.getElementById('header-title').textContent = 'Painel da Cozinha';
            document.getElementById('main-container').innerHTML = `<div id="cozinha-view" class="h-full flex flex-col"></div>`;
            setupCozinhaView();
        };

        // --- GESTÃO DE USUÁRIOS (NOVO) ---
        const abrirUsuariosView = async () => {
            const modal = document.getElementById('usuarios-view');
            modal.classList.remove('hidden');
            modal.innerHTML = `<div class="bg-gray-800 w-full max-w-3xl h-auto max-h-[80vh] rounded-2xl shadow-2xl flex flex-col fade-in">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Gestão de Usuários</h2>
                    <button onclick="fecharUsuariosView()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
                </header>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto">
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h3 class="text-lg font-bold mb-3">Adicionar Novo Usuário</h3>
                        <form id="add-user-form" class="space-y-3">
                            <input type="text" id="new-user-name" placeholder="Nome Completo" required class="w-full bg-gray-700 p-2 rounded">
                            <input type="email" id="new-user-email" placeholder="Email de Login" required class="w-full bg-gray-700 p-2 rounded">
                            <input type="password" id="new-user-password" placeholder="Senha Provisória" required class="w-full bg-gray-700 p-2 rounded">
                            <select id="new-user-profile" required class="w-full bg-gray-700 p-2 rounded">
                                <option value="atendente">Atendente</option>
                                <option value="cozinha">Cozinha</option>
                                <option value="caixa">Caixa (Admin)</option>
                            </select>
                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Criar Usuário</button>
                        </form>
                    </div>
                    <div id="user-list-container" class="bg-gray-900 p-4 rounded-lg overflow-y-auto">
                        <h3 class="text-lg font-bold mb-3">Usuários Cadastrados</h3>
                        <div id="user-list" class="space-y-2">Carregando...</div>
                    </div>
                </div>
            </div>`;
            
            document.getElementById('add-user-form').addEventListener('submit', handleAddUser);
            loadUserList();
        };
        
        const loadUserList = async () => {
            const userListEl = document.getElementById('user-list');
            const q = query(collection(db, "usuarios"), orderBy("nome"));
            onSnapshot(q, (snapshot) => {
                userListEl.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const userEl = document.createElement('div');
                    userEl.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    const podeMudarStatus = docSnap.id !== currentUser.uid;
                    userEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${user.nome} ${docSnap.id === currentUser.uid ? '(Você)' : ''}</p>
                            <p class="text-xs text-gray-400 capitalize">${user.perfil} - ${user.email}</p>
                        </div>
                        ${podeMudarStatus ? `<button data-uid="${docSnap.id}" data-status="${user.status}" class="user-status-btn px-3 py-1 text-sm rounded ${user.status === 'ativo' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}">${user.status === 'ativo' ? 'Desativar' : 'Ativar'}</button>` : ''}
                    `;
                    userListEl.appendChild(userEl);
                });
                document.querySelectorAll('.user-status-btn').forEach(btn => btn.addEventListener('click', toggleUserStatus));
            });
        };
        
        const toggleUserStatus = async (e) => {
            const uid = e.target.dataset.uid;
            const currentStatus = e.target.dataset.status;
            const newStatus = currentStatus === 'ativo' ? 'inativo' : 'ativo';
            if (confirm(`Tem certeza que deseja ${newStatus === 'ativo' ? 'ativar' : 'desativar'} este usuário?`)) {
                await updateDoc(doc(db, 'usuarios', uid), { status: newStatus });
                showNotification('Status do usuário atualizado!', 'success');
            }
        };

        const handleAddUser = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const perfil = document.getElementById('new-user-profile').value;

            const statusEl = showNotification('Criando usuário...', 'info');
            
            // Usamos uma Cloud Function (ou um backend) para criar usuários de forma segura.
            // Como estamos no client-side, fazemos uma "gambiarra":
            // 1. Criamos o usuário
            // 2. Deslogamos o admin
            // 3. Relogamos o admin
            // Isso é necessário porque o SDK do cliente não permite criar usuários enquanto outro está logado, sem impactar o estado de autenticação.
            try {
                // Para não deslogar o admin, a melhor abordagem client-side é complexa.
                // A solução mais simples é pedir ao admin para relogar após criar um usuário.
                // Idealmente, isso seria uma função de back-end.
                // Por enquanto, vamos criar e depois pedir para o admin atualizar a página se algo der errado.
                // Isso requer configuração de regras de segurança para permitir que um admin crie usuários.
                // Vamos simplificar por agora:
                alert("Atenção: A criação de usuários diretamente pelo cliente é uma operação complexa.\nPor enquanto, esta função está desabilitada para evitar problemas de segurança.\nEm uma próxima fase, implementaremos isso com segurança usando Cloud Functions.");

                // A lógica abaixo é a que USARÍAMOS, mas ela tem o problema de deslogar o admin.
                /*
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "usuarios", userCredential.user.uid), {
                    nome, email, perfil, status: 'ativo', criadoEm: serverTimestamp()
                });
                showNotification(`Usuário ${nome} criado com sucesso!`);
                e.target.reset();
                // A parte complexa: relogar o admin
                await signInWithEmailAndPassword(auth, currentUser.email, prompt('Sua sessão foi renovada. Por favor, digite sua senha de admin novamente para continuar:'));
                */
            } catch (error) {
                showNotification('Erro ao criar usuário.', 'error');
                console.error("Erro ao criar usuário:", error);
            }
        };

        const fecharUsuariosView = () => document.getElementById('usuarios-view').classList.add('hidden');

        const abrirModalAberturaCaixa = () => {
            const modal = document.getElementById('abrir-caixa-view');
            modal.classList.remove('hidden');
            modal.innerHTML = `<div class="bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl p-6 fade-in"><h3 class="text-xl font-bold mb-4">Abrir Caixa</h3><p class="text-sm text-gray-400 mb-4">Digite o valor inicial do caixa para troco (suprimento).</p><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">R$</span><input type="number" id="valor-abertura" class="w-full bg-gray-700 text-white p-3 pl-10 rounded-lg text-lg border-0" placeholder="0,00"></div><div class="grid grid-cols-2 gap-3 mt-6"><button onclick="document.getElementById('abrir-caixa-view').classList.add('hidden')" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button><button onclick="abrirCaixa()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar Abertura</button></div></div>`;
            document.getElementById('valor-abertura').focus();
        };

        const abrirCaixa = async () => {
            const valorInput = document.getElementById('valor-abertura');
            const valorAbertura = parseFloat(valorInput.value) || 0;
            const novoStatus = { status: 'aberto', valorAbertura: valorAbertura, abertoEm: serverTimestamp(), abertoPor: currentUser.uid };
            await setDoc(doc(db, "configuracao", "caixa"), novoStatus);
            document.getElementById('abrir-caixa-view').classList.add('hidden');
            showNotification(`Caixa aberto com ${formatCurrency(valorAbertura)}!`);
        };

        const fecharCaixa = async () => {
            if (confirm("Tem certeza que deseja fechar o caixa? Esta ação encerrará o expediente.")) {
                const novoStatus = { ...caixaStatus, status: 'fechado', fechadoEm: serverTimestamp(), fechadoPor: currentUser.uid };
                await setDoc(doc(db, "configuracao", "caixa"), novoStatus);
                showNotification('Caixa fechado com sucesso!');
            }
        };

        const setupMesasView = () => {
            const grid = document.getElementById('mesas-grid'); if(!grid) return;
            grid.innerHTML = '';
            for (let i = 1; i <= 50; i++) {
                const mesaEl = document.createElement('div'); mesaEl.id = `mesa-${i}`;
                mesaEl.className = 'p-2 rounded-lg text-center cursor-pointer transition-all duration-300';
                mesaEl.innerHTML = `<div class="font-extrabold text-3xl">${i}</div><div class="text-xs font-semibold"></div>`;
                grid.appendChild(mesaEl);
            }
            const unsub = onSnapshot(collection(db, "mesas"), snapshot => {
                let mesasAtivas = new Set();
                snapshot.forEach(doc => { updateMesaCard(doc.id, doc.data()); mesasAtivas.add(doc.id); });
                for (let i = 1; i <= 50; i++) if (!mesasAtivas.has(String(i))) updateMesaCard(i, { status: 'livre' });
            });
            listeners.push(unsub);
        };

        const updateMesaCard = (numero, data) => {
            const mesaEl = document.getElementById(`mesa-${numero}`); if (!mesaEl) return;
            const status = data.status || 'livre'; const total = data.total || 0;
            const nomeCliente = data.cliente || '';
            mesaEl.classList.remove('bg-green-600', 'bg-red-600', 'hover:bg-green-500', 'hover:bg-red-500');
            if (status === 'livre') {
                mesaEl.classList.add('bg-green-600', 'hover:bg-green-500'); 
                mesaEl.children[1].textContent = 'Livre';
            } else {
                mesaEl.classList.add('bg-red-600', 'hover:bg-red-500');
                mesaEl.children[1].innerHTML = `${nomeCliente ? `<span class='block text-xs truncate font-normal'>${nomeCliente}</span>` : ''}<span class="font-bold">${formatCurrency(total)}</span>`;
            }
            mesaEl.onclick = () => handleMesaClick(numero, data);
        };

        const handleMesaClick = async (numero, data) => {
            if (currentUser.perfil === 'atendente') {
                abrirPdvView(numero);
            } else if (currentUser.perfil === 'caixa' && data.status === 'ocupada') {
                mesaSelecionada = { numero, ...data };
                abrirDetalheCaixaView();
            }
        };

        const abrirPdvView = async (numero) => {
            const mesaDoc = await getDoc(doc(db, "mesas", String(numero)));
            mesaSelecionada = { numero, ...mesaDoc.data() };
            comandaTemporaria = mesaSelecionada.itens ? JSON.parse(JSON.stringify(mesaSelecionada.itens)) : [];
            document.getElementById('pdv-view').classList.remove('hidden');
            renderPdvScreen('adicionar'); 
        };

        const fecharPdvView = () => {
            const el = document.getElementById('pdv-view');
            const modal = el.querySelector('.fade-in');
            if(modal) {
                modal.classList.add('fade-out');
                setTimeout(() => { el.innerHTML = ''; el.classList.add('hidden'); }, 400);
            } else { el.innerHTML = ''; el.classList.add('hidden'); }
        };
        
        const renderPdvScreen = (screen) => {
            const container = document.getElementById('pdv-view');
            const totalItens = comandaTemporaria.reduce((acc, item) => acc + item.quantidade, 0);
            const screenHtml = `<div class="bg-gray-800 w-full h-full flex flex-col fade-in"><header class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0 bg-gray-800"><h2 class="text-2xl font-bold">Mesa ${mesaSelecionada.numero}</h2></header><main class="flex-1 overflow-y-auto bg-gray-900"></main><footer class="flex-shrink-0 bg-gray-800 border-t border-gray-700 grid grid-cols-3 text-center text-gray-400"><button onclick="renderPdvScreen('conta')" class="p-4 relative ${screen === 'conta' ? 'nav-active' : ''}"><i class="fas fa-receipt text-2xl"></i><span class="text-xs block mt-1">Ver Conta</span>${totalItens > 0 ? `<span class="absolute top-2 right-6 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${totalItens}</span>` : ''}</button><button onclick="renderPdvScreen('adicionar')" class="p-4 ${screen === 'adicionar' ? 'nav-active' : ''}"><i class="fas fa-plus text-2xl"></i><span class="text-xs block mt-1">Adicionar Itens</span></button><button onclick="fecharPdvView()" class="p-4"><i class="fas fa-table-cells text-2xl"></i><span class="text-xs block mt-1">Mesas</span></button></footer></div>`;
            container.innerHTML = screenHtml;
            const mainContainer = container.querySelector('main');
            if (screen === 'adicionar') {
                mainContainer.innerHTML = `<div class="p-3 border-b border-gray-700 flex-shrink-0 bg-gray-800 sticky top-0 z-10"><div id="categorias-container" class="flex items-center gap-2 overflow-x-auto no-scrollbar"></div></div><div id="produtos-container" class="p-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>`;
                renderCategorias(); renderProdutos(Object.keys(cardapio)[0]);
            } else if (screen === 'conta') {
                mainContainer.innerHTML = `<div class="p-4 flex flex-col h-full"><div class="mb-4"><label for="cliente-nome" class="text-sm text-gray-400">Nome do Cliente (Opcional)</label><input type="text" id="cliente-nome" value="${mesaSelecionada.cliente || ''}" class="w-full bg-gray-700 text-white p-2 rounded-lg mt-1 border-0" placeholder="Digite o nome aqui..."></div><h3 class="text-xl font-semibold mb-4 flex-shrink-0">Comanda da Mesa</h3><div id="comanda-itens" class="flex-1 space-y-2 overflow-y-auto no-scrollbar pr-2 mb-4"></div><div class="border-t border-gray-700 pt-4 flex-shrink-0"><div class="flex justify-between items-center text-2xl font-bold mb-4"><span>Total</span><span id="comanda-total">R$ 0,00</span></div><button onclick="enviarPedido()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-lg flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> Salvar & Enviar para Cozinha</button></div></div>`;
                renderComanda();
            }
        };

        const renderCategorias = () => { /* ... código idêntico ao anterior ... */ };
        const renderProdutos = (categoria) => { /* ... código idêntico ao anterior ... */ };
        const abrirDetalhesItem = (item) => { /* ... código idêntico ao anterior ... */ };
        const fecharDetalhesItem = () => document.getElementById('item-details-view').classList.add('hidden');
        const renderComanda = () => { /* ... código idêntico ao anterior ... */ };
        const changeQty = (itemIndex, amount) => { /* ... código idêntico ao anterior ... */ };
        const enviarPedido = async () => { /* ... código idêntico ao anterior ... */ };
        const setupCozinhaView = () => { /* ... código idêntico ao anterior ... */ };
        const renderCozinhaScreen = async (status) => { /* ... código idêntico ao anterior ... */ };
        const renderPedidoCard = (id, pedido) => { /* ... código idêntico ao anterior ... */ };
        const updateTimers = () => { /* ... código idêntico ao anterior ... */ };
        const marcarPedidoPronto = async id => { /* ... código idêntico ao anterior ... */ };
        const loadHistorico = async () => { /* ... código idêntico ao anterior ... */ };
        const abrirDetalheCaixaView = () => { /* ... código idêntico ao anterior ... */ };
        const fecharDetalheCaixaView = () => document.getElementById('caixa-detalhe-view').classList.add('hidden');
        const fecharConta = async () => { /* ... código idêntico ao anterior ... */ };
        const abrirRelatoriosView = async () => { /* ... código idêntico ao anterior ... */ };
        const fecharRelatoriosView = () => document.getElementById('relatorios-view').classList.add('hidden');
        const showNotification = (message, type = 'success') => {
            const el = document.getElementById('notification');
            if(!el) return;
            el.querySelector('p').textContent = message;
            el.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            if(type === 'success') el.classList.add('bg-green-500');
            else if(type === 'error') el.classList.add('bg-red-500');
            else el.classList.add('bg-blue-500');
            el.classList.add('fade-in');
            setTimeout(() => {
                el.classList.remove('fade-in'); el.classList.add('hidden');
            }, 3000);
        };
        const formatCurrency = v => v ? v.toLocaleString('pt-BR', { style: 'currency', 'currency': 'BRL' }) : 'R$ 0,00';
        
        window.logout = logout; window.abrirUsuariosView = abrirUsuariosView; window.fecharUsuariosView = fecharUsuariosView; window.abrirModalAberturaCaixa = abrirModalAberturaCaixa; window.abrirCaixa = abrirCaixa; window.fecharCaixa = fecharCaixa; window.handleMesaClick = handleMesaClick; window.abrirPdvView = abrirPdvView; window.fecharPdvView = fecharPdvView; window.renderPdvScreen = renderPdvScreen; window.abrirDetalhesItem = abrirDetalhesItem; window.fecharDetalhesItem = fecharDetalhesItem; window.renderComanda = renderComanda; window.changeQty = changeQty; window.enviarPedido = enviarPedido; window.renderCozinhaScreen = renderCozinhaScreen; window.marcarPedidoPronto = marcarPedidoPronto; window.abrirDetalheCaixaView = abrirDetalheCaixaView; window.fecharDetalheCaixaView = fecharDetalheCaixaView; window.fecharConta = fecharConta; window.abrirRelatoriosView = abrirRelatoriosView; window.fecharRelatoriosView = fecharRelatoriosView;
        
        initFirebase();
    </script>
</body>
</html>

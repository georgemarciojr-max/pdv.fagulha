<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fagulha Grill - PDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .nav-active {
            color: #1f2937; /* gray-800 */
            background-color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <div id="app" class="h-full flex flex-col">

        <div id="login-view" class="flex flex-col items-center justify-center h-full bg-gray-800 p-4">
            <div class="w-full max-w-sm bg-gray-900 p-8 rounded-2xl shadow-2xl text-center fade-in">
                <i class="fas fa-utensils text-5xl text-amber-400 mb-4"></i>
                <h1 class="text-4xl font-extrabold text-white mb-2">Fagulha Grill</h1>
                <p class="text-gray-400 mb-8">Acesso ao Sistema PDV</p>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700 text-white p-3 rounded-lg border-0" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full bg-gray-700 text-white p-3 rounded-lg border-0" required>
                    <button type="submit" class="w-full text-lg bg-amber-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-amber-700 transition-all duration-300 shadow-lg flex items-center justify-center gap-3">
                        <i class="fas fa-sign-in-alt"></i>Entrar
                    </button>
                </form>
                <p id="login-error" class="text-red-500 text-sm mt-4 h-5"></p>
            </div>
        </div>

        <div id="main-view" class="hidden h-full flex flex-col">
            <header class="bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-center border-b border-gray-700">
                <div>
                    <h1 class="text-2xl font-bold" id="header-title"></h1>
                    <p class="text-xs text-gray-400" id="user-info"></p>
                </div>
                <div id="header-actions" class="flex items-center gap-3">
                    <button onclick="handleLogout()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto" id="main-container"></main>
        </div>
        
        <div id="pdv-view" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col"></div>
        <div id="caixa-detalhe-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="item-details-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="relatorios-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="abrir-caixa-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
        <div id="gestao-usuarios-view" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"></div>
        <div id="notification-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, writeBatch, serverTimestamp, updateDoc, query, where, getDoc, orderBy, getDocs, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3rqB_5P8UKl8jTFBTD6L4_jnIPgvTkJA",
            authDomain: "fagula-grill.firebaseapp.com",
            projectId: "fagula-grill",
            storageBucket: "fagula-grill.appspot.com",
            messagingSenderId: "537393387141",
            appId: "1:537393387141:web:1bc57d34575eaa2eb53bec",
            measurementId: "G-LGJBCZGC4C"
        };
        
        const cardapio = { "Espetos Clássicos": [ { id: 'esp-frango', nome: 'Frango', preco: 10.00 }, { id: 'esp-coracao', nome: 'Coração', preco: 10.00 }, { id: 'esp-linguica', nome: 'Linguiça', preco: 10.00 }, { id: 'esp-paoalho', nome: 'Pão de Alho', preco: 10.00 }, { id: 'esp-santamassa', nome: 'Santa Massa', preco: 10.00 }, { id: 'esp-queijo', nome: 'Queijo Coalho', preco: 12.00 }, { id: 'esp-torresmo-espeto', nome: 'Torresmo', preco: 12.00 }, { id: 'esp-kafta', nome: 'Kafta', preco: 12.00 }, { id: 'esp-alcatra', nome: 'Alcatra', preco: 14.00 } ], "Espetos Premium": [ { id: 'prem-costela', nome: 'Costela', preco: 18.00 }, { id: 'prem-picanha', nome: 'Picanha', preco: 18.00, description: 'Maturatta Friboi' }, { id: 'prem-medalhao-alcatra', nome: 'Medalhão de Alcatra', preco: 18.00 }, { id: 'prem-medalhao-palmito', nome: 'Medalhão de Palmito', preco: 18.00 }, { id: 'prem-kafta-queijo', nome: 'Kafta com Queijo', preco: 16.00 }, { id: 'prem-medalhao-frango', nome: 'Medalhão de Frango', preco: 16.00 }, { id: 'prem-romeujulieta', nome: 'Medalhão Romeu e Julieta', preco: 16.00 }, { id: 'prem-almondega', nome: 'Medalhão de Almôndega', preco: 16.00 }, { id: 'prem-vegetariano', nome: 'Vegetariano', preco: 16.00 }, { id: 'prem-mandioca', nome: 'Medalhão de Mandioca', preco: 16.00, description: 'Com carne seca e queijo' } ], "Entradas": [ { id: 'ent-torresmo', nome: 'Torresmo (Individual)', preco: 24.00, description: 'Barrinha de panceta' }, { id: 'ent-bolinho-costela', nome: 'Bolinho de Costela (3und)', preco: 24.00 }, { id: 'ent-pao-kafta', nome: 'Pão de Alho com Kafta e Queijo', preco: 24.00 }, { id: 'ent-porpetone', nome: 'Porpetone', preco: 26.00, description: 'Bolo de carne artesanal recheado com queijo assado na churrasqueira' }, { id: 'ent-salaminho', nome: 'Salaminho (100g)', preco: 18.00 }, { id: 'ent-frios', nome: 'Pratinho de Frios', preco: 39.00, description: 'Salame, mussarela, ovo de codorna e azeitonas' }, { id: 'ent-paolica', nome: 'Pãoliça (Porção Individual)', preco: 19.00, description: 'Massa de linguiça temperada, queijo mussarela e molho verde no pão francês grelhado' } ], "Acompanhamentos": [ { id: 'acomp-trio', nome: 'Trio', preco: 10.00, description: 'Vinagrete, farofa e molho verde' } ], "Bebidas & Cia": [ { id: 'refri-lata', nome: 'Refrigerante Lata', preco: 5.00 }, { id: 'agua-com-gas', nome: 'Água c/ Gás', preco: 4.00 }, { id: 'agua-sem-gas', nome: 'Água s/ Gás', preco: 3.00 }, { id: 'h2oh', nome: 'H2OH!', preco: 6.00 }, { id: 'suco-lata', nome: 'Suco Lata', preco: 6.00 }, { id: 'energetico', nome: 'Energético', preco: 12.00 }, { id: 'heineken-ln', nome: 'Heineken LN', preco: 10.00 }, { id: 'bud-ln', nome: 'Budweiser LN', preco: 9.00 }, { id: 'stella-ln', nome: 'Stella Artois LN', preco: 9.00 }, { id: 'heineken-600', nome: 'Heineken 600ml', preco: 18.00 }, { id: 'original-600', nome: 'Original 600ml', preco: 15.00 }, { id: 'bud-600', nome: 'Budweiser 600ml', preco: 15.00 }, { id: 'suco-jarra', nome: 'Suco Jarra 1L', preco: 15.00 }, { id: 'dose-campari', nome: 'Dose Campari', preco: 10.00 }, { id: 'dose-gin', nome: 'Dose Gin', preco: 15.00 }, { id: 'dose-redlabel', nome: 'Dose Red Label', preco: 15.00 }, { id: 'dose-oldparr', nome: 'Dose Old Parr', preco: 18.00 }, { id: 'drink-gintonica', nome: 'Gin Tônica', preco: 25.00 }, { id: 'drink-caipirinha', nome: 'Caipirinha', preco: 18.00 } ] };

        // Variáveis globais
        let app, auth, db, usuarioLogado, mesaSelecionada, comandaTemporaria = [], listeners = [], synth;
        let caixaStatus = { status: 'fechado' };

        // --- FASE 1: INICIALIZAÇÃO E LÓGICA DE LOGIN ---
        const initFirebase = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                        if (userDoc.exists() && userDoc.data().status === 'ativo') {
                            usuarioLogado = { uid: user.uid, ...userDoc.data() };
                            document.getElementById('login-view').classList.add('hidden');
                            document.getElementById('main-view').classList.remove('hidden');
                            iniciarSistema();
                        } else {
                            handleLogout("Usuário não encontrado ou inativo.");
                        }
                    } else {
                        document.getElementById('login-view').classList.remove('hidden');
                        document.getElementById('main-view').classList.add('hidden');
                        limparTudo();
                    }
                });

                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.body.addEventListener('click', () => { if (!synth) synth = new Tone.Synth().toDestination(); }, { once: true });

            } catch (e) {
                console.error("Erro de inicialização do Firebase:", e);
                document.getElementById('login-error').textContent = 'Erro de configuração do Firebase.';
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged irá lidar com o resto
            } catch (error) {
                console.error("Erro de login:", error.code);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    errorEl.textContent = 'Email ou senha inválidos.';
                } else {
                    errorEl.textContent = 'Erro ao tentar fazer login.';
                }
            }
        };

        const handleLogout = async (msg = '') => {
            if (msg) console.log(msg);
            await signOut(auth);
            limparTudo();
        };

        const limparTudo = () => {
            usuarioLogado = null;
            listeners.forEach(unsub => unsub());
            listeners = [];
            // Limpa qualquer timer
            if (window.cozinhaTimerInterval) clearInterval(window.cozinhaTimerInterval);
            window.cozinhaTimerInterval = null;
        };

        const iniciarSistema = () => {
            document.getElementById('user-info').innerHTML = `Logado como: <strong>${usuarioLogado.nome}</strong> (${usuarioLogado.perfil})`;
            const headerActions = document.getElementById('header-actions');
            // Limpa actions antigas, exceto o botão de sair
            headerActions.querySelectorAll('button:not(:last-child)').forEach(btn => btn.remove());

            // Adiciona botões específicos do perfil
            if (usuarioLogado.perfil === 'caixa') {
                const gestaoBtn = document.createElement('button');
                gestaoBtn.innerHTML = `<i class="fas fa-users-cog mr-2"></i>Gerenciar Usuários`;
                gestaoBtn.className = "bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors";
                gestaoBtn.onclick = abrirGestaoUsuariosView;
                headerActions.prepend(gestaoBtn);
            }

            // Listener para o status do caixa
            listeners.push(onSnapshot(doc(db, "configuracao", "caixa"), (doc) => {
                caixaStatus = doc.exists() ? doc.data() : { status: 'fechado' };
                rotearParaViewPrincipal();
            }));
        };

        const rotearParaViewPrincipal = () => {
            const mainContainer = document.getElementById('main-container');

            if (usuarioLogado.perfil === 'caixa') {
                if (caixaStatus.status === 'aberto') {
                    renderCaixaAbertoView();
                } else {
                    renderCaixaFechadoView();
                }
            } else if (usuarioLogado.perfil === 'atendente') {
                if (caixaStatus.status !== 'aberto') {
                    mainContainer.innerHTML = `<div class="p-8 text-center"><i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold">O Caixa está fechado.</h2><p class="text-gray-400">Aguarde o caixa ser aberto para iniciar os atendimentos.</p></div>`;
                } else {
                    document.getElementById('header-title').textContent = 'Mapa de Mesas';
                    mainContainer.innerHTML = `<div id="mesas-view" class="p-4 sm:p-6"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>`;
                    setupMesasView();
                    setupNotificacaoListener(); // FASE 4: Ativa notificações para o atendente
                }
            } else if (usuarioLogado.perfil === 'cozinha') {
                 if (caixaStatus.status !== 'aberto') {
                    mainContainer.innerHTML = `<div class="p-8 text-center"><i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold">O Caixa está fechado.</h2><p class="text-gray-400">A cozinha opera apenas com o caixa aberto.</p></div>`;
                } else {
                    document.getElementById('header-title').textContent = 'Painel da Cozinha';
                    mainContainer.innerHTML = `<div id="cozinha-view" class="h-full flex flex-col"></div>`;
                    setupCozinhaView();
                }
            }
        };

        // --- FASE 1: GESTÃO DE USUÁRIOS (VISÍVEL APENAS PARA O 'CAIXA') ---
        const abrirGestaoUsuariosView = async () => {
            const modal = document.getElementById('gestao-usuarios-view');
            modal.classList.remove('hidden');
            modal.innerHTML = `
                <div class="bg-gray-800 w-full max-w-4xl h-auto max-h-[90vh] rounded-2xl shadow-2xl flex flex-col fade-in">
                    <header class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Gestão de Usuários</h2>
                        <button onclick="document.getElementById('gestao-usuarios-view').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
                    </header>
                    <main class="p-6 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg mb-2">Usuários Cadastrados</h3>
                            <div id="lista-usuarios" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">Novo Usuário</h3>
                            <form id="form-novo-usuario" class="space-y-3 bg-gray-700 p-4 rounded-lg">
                                <input type="text" id="novo-nome" placeholder="Nome Completo" class="w-full bg-gray-600 p-2 rounded" required>
                                <input type="email" id="novo-email" placeholder="Email de Login" class="w-full bg-gray-600 p-2 rounded" required>
                                <input type="password" id="novo-senha" placeholder="Senha Provisória" class="w-full bg-gray-600 p-2 rounded" required>
                                <select id="novo-perfil" class="w-full bg-gray-600 p-2 rounded" required>
                                    <option value="" disabled selected>Selecione o Perfil</option>
                                    <option value="atendente">Atendente</option>
                                    <option value="cozinha">Cozinha</option>
                                    <option value="caixa">Caixa</option>
                                </select>
                                <button type="submit" class="w-full bg-green-600 font-bold p-2 rounded hover:bg-green-700">Criar Usuário</button>
                            </form>
                        </div>
                    </main>
                </div>
            `;
            
            document.getElementById('form-novo-usuario').addEventListener('submit', handleCriarUsuario);
            carregarListaUsuarios();
        };

        const carregarListaUsuarios = () => {
            const container = document.getElementById('lista-usuarios');
            if (!container) return;
            container.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Carregando...`;

            const q = query(collection(db, "usuarios"), orderBy("nome"));
            // Usar onSnapshot para atualizar a lista em tempo real
            const unsub = onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    container.innerHTML = `<p class="text-gray-400">Nenhum usuário cadastrado.</p>`;
                    return;
                }
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userEl = document.createElement('div');
                    userEl.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    userEl.innerHTML = `
                        <div>
                            <p class="font-bold">${user.nome}</p>
                            <p class="text-sm text-gray-400">${user.email} - <span class="capitalize">${user.perfil}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${user.status === 'ativo' ? 'bg-green-500' : 'bg-red-500'}">${user.status}</span>
                            ${usuarioLogado.uid !== doc.id ? `<button onclick="toggleUserStatus('${doc.id}', '${user.status}')" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded">${user.status === 'ativo' ? 'Desativar' : 'Ativar'}</button>` : ''}
                        </div>
                    `;
                    container.appendChild(userEl);
                });
            });
            listeners.push(unsub); // Adicionar à lista para limpar no logout
        };
        
        const handleCriarUsuario = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('novo-nome').value;
            const email = document.getElementById('novo-email').value;
            const senha = document.getElementById('novo-senha').value;
            const perfil = document.getElementById('novo-perfil').value;

            if (!nome || !email || !senha || !perfil) {
                showNotification("Preencha todos os campos do novo usuário.", "error");
                return;
            }

            // --- Início da Mágica: Conexão Temporária ---
            const appName = `temp-user-creation-${Date.now()}`;
            const tempApp = initializeApp(firebaseConfig, appName);
            const tempAuth = getAuth(tempApp);
            // --- Fim da Mágica ---

            showNotification("Processando criação...", "info");

            try {
                // 1. Criar o usuário no serviço de Autenticação usando a conexão temporária
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, senha);
                const newUser = userCredential.user;

                // 2. Criar o documento do usuário no Firestore usando a conexão principal (db)
                await setDoc(doc(db, "usuarios", newUser.uid), {
                    nome: nome,
                    email: email,
                    perfil: perfil,
                    status: 'ativo'
                });
                
                // 3. Deslogar o usuário recém-criado da conexão temporária (boa prática)
                await signOut(tempAuth);
                
                showNotification(`Usuário "${nome}" criado com sucesso!`, "success");
                e.target.reset(); // Limpa o formulário

            } catch (error) {
                console.error("Erro ao criar usuário:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showNotification("Este email já está cadastrado no sistema.", "error");
                } else if (error.code === 'auth/weak-password') {
                    showNotification("A senha precisa ter no mínimo 6 caracteres.", "error");
                } else {
                    showNotification("Ocorreu um erro ao criar o usuário.", "error");
                }
            }
        };

        const toggleUserStatus = async (uid, statusAtual) => {
            const novoStatus = statusAtual === 'ativo' ? 'inativo' : 'ativo';
            await updateDoc(doc(db, "usuarios", uid), { status: novoStatus });
            showNotification(`Usuário ${novoStatus === 'ativo' ? 'ativado' : 'desativado'} com sucesso!`, 'success');
        };

        const renderCaixaAbertoView = () => {
            document.getElementById('header-title').textContent = 'Painel do Caixa';
            const headerActions = document.getElementById('header-actions');
            if(!document.getElementById('relatorios-btn')) {
                const relatoriosBtn = document.createElement('button');
                relatoriosBtn.id = 'relatorios-btn';
                relatoriosBtn.innerHTML = `<i class="fas fa-chart-line"></i> Relatórios`;
                relatoriosBtn.className = `bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-500 transition-colors flex items-center gap-2`;
                relatoriosBtn.onclick = abrirRelatoriosView;
                headerActions.prepend(relatoriosBtn);
            }
            if(!document.getElementById('fechar-caixa-btn')) {
                const fecharCaixaBtn = document.createElement('button');
                fecharCaixaBtn.id = 'fechar-caixa-btn';
                fecharCaixaBtn.innerHTML = `<i class="fas fa-door-open"></i> Fechar Caixa`;
                fecharCaixaBtn.className = `bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-500 transition-colors flex items-center gap-2`;
                fecharCaixaBtn.onclick = fecharCaixa;
                headerActions.prepend(fecharCaixaBtn);
            }
            
            document.getElementById('main-container').innerHTML = `<div id="mesas-view" class="p-4 sm:p-6"><div id="mesas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4"></div></div>`;
            setupMesasView();
        };

        const fecharConta = async () => {
             if (!mesaSelecionada || !mesaSelecionada.itens || mesaSelecionada.itens.length === 0) {
                showNotification('A mesa está vazia, não é possível fechar.', 'error'); return;
            }
            const batch = writeBatch(db);
            const vendaRef = doc(collection(db, "vendas_finalizadas"));
            batch.set(vendaRef, {
                mesa: mesaSelecionada.numero, cliente: mesaSelecionada.cliente || '',
                itens: mesaSelecionada.itens, total: mesaSelecionada.total,
                abertaEm: mesaSelecionada.abertaEm, finalizadaEm: serverTimestamp(),
                fechadoPor: { uid: usuarioLogado.uid, nome: usuarioLogado.nome }
            });
            batch.delete(doc(db, "mesas", String(mesaSelecionada.numero)));
            await batch.commit();
            showNotification(`Mesa ${mesaSelecionada.numero} fechada com sucesso!`);
            fecharDetalheCaixaView();
        };

        const abrirDetalheCaixaView = () => {
            const modal = document.getElementById('caixa-detalhe-view');
            modal.innerHTML = `
             <div class="bg-gray-800 w-full max-w-md h-auto max-h-[80vh] rounded-2xl shadow-2xl flex flex-col fade-in">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">Detalhes - Mesa ${mesaSelecionada.numero}</h2><button onclick="fecharDetalheCaixaView()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button></header>
                <div class="p-6 overflow-y-auto no-scrollbar">
                    ${mesaSelecionada.cliente ? `<p class="text-lg mb-4">Cliente: <span class="font-bold text-amber-400">${mesaSelecionada.cliente}</span></p>`: ''}
                    <ul id="caixa-itens-lista" class="space-y-3 mb-6"></ul>
                    <div class="border-t border-gray-700 pt-4 space-y-3">
                        <div class="flex justify-between items-center text-3xl font-extrabold"><span>Total</span><span id="caixa-total-mesa">${formatCurrency(mesaSelecionada.total || 0)}</span></div>
                        <button onclick="fecharConta()" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-700 text-lg flex items-center justify-center gap-2"><i class="fas fa-receipt"></i> Fechar Conta</button>
                        <button onclick="cancelarPedidosMesa(${mesaSelecionada.numero})" class="w-full bg-red-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 text-sm flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i> Cancelar Pedidos Pendentes</button>
                    </div>
                </div>
             </div>`;
            const listaItens = modal.querySelector('#caixa-itens-lista');
            if (mesaSelecionada.itens?.length > 0) {
                 mesaSelecionada.itens.forEach(item => {
                    const li = document.createElement('li'); li.className = "flex justify-between items-start text-lg flex-wrap";
                    li.innerHTML = `<span class="mr-2">${item.quantidade}x ${item.nome}</span><span class="font-semibold ml-auto">${formatCurrency(item.preco * item.quantidade)}</span>${item.observacao ? `<span class="w-full text-left text-xs text-amber-400 italic block">Obs: ${item.observacao}</span>` : ''}`;
                    listaItens.appendChild(li);
                });
            } else { listaItens.innerHTML = `<p class="text-gray-400">Nenhum item lançado.</p>`; }
            modal.classList.remove('hidden');
        };

        const cancelarPedidosMesa = async (numeroMesa) => {
            if(!confirm(`Tem certeza que deseja cancelar TODOS os pedidos PENDENTES da mesa ${numeroMesa}? Os itens serão removidos da conta.`)) return;

            const q = query(collection(db, "pedidos_cozinha"), where("mesa", "==", numeroMesa), where("status", "==", "pendente"));
            const pedidosParaCancelar = await getDocs(q);

            if (pedidosParaCancelar.empty) {
                showNotification("Nenhum pedido pendente para cancelar nesta mesa.", "info");
                return;
            }

            const batch = writeBatch(db);
            pedidosParaCancelar.forEach(doc => {
                batch.update(doc.ref, { 
                    status: 'cancelado',
                    canceladoPor: { uid: usuarioLogado.uid, nome: usuarioLogado.nome },
                    canceladoEm: serverTimestamp()
                });
            });
            
            const mesaRef = doc(db, "mesas", String(numeroMesa));
            batch.update(mesaRef, { itens: [], total: 0 });
            showNotification("A mesa foi zerada. Relance os itens que permaneceram.", "info");
            
            await batch.commit();
            showNotification(`Pedidos da mesa ${numeroMesa} cancelados!`, "success");
            fecharDetalheCaixaView();
        };

        const enviarPedido = async () => {
            const nomeCliente = document.getElementById('cliente-nome')?.value.trim() || mesaSelecionada.cliente || '';
            const itensOriginais = mesaSelecionada.itens || [];
            const itensEnviados = comandaTemporaria.filter(item => {
                const itemOriginal = itensOriginais.find(i => i.id === item.id && i.observacao === item.observacao);
                return !itemOriginal || item.quantidade > itemOriginal.quantidade;
            }).map(item => {
                const itemOriginal = itensOriginais.find(i => i.id === item.id && i.observacao === item.observacao);
                return { ...item, quantidade: itemOriginal ? item.quantidade - itemOriginal.quantidade : item.quantidade };
            }).filter(item => item.quantidade > 0);

            if (itensEnviados.length === 0 && nomeCliente === (mesaSelecionada.cliente || '')) { 
                showNotification('Nenhuma alteração para enviar.', 'info'); return; 
            }
            const batch = writeBatch(db);
            if(itensEnviados.length > 0) {
                const pedidoCozinhaRef = doc(collection(db, "pedidos_cozinha"));
                batch.set(pedidoCozinhaRef, {
                    mesa: mesaSelecionada.numero, cliente: nomeCliente, itens: itensEnviados, 
                    status: 'pendente', criadoEm: serverTimestamp(),
                    lancadoPor: { uid: usuarioLogado.uid, nome: usuarioLogado.nome }
                });
            }
            const mesaRef = doc(db, "mesas", String(mesaSelecionada.numero));
            const novoTotal = comandaTemporaria.reduce((acc, item) => acc + (item.preco * item.quantidade), 0);
            batch.set(mesaRef, { status: 'ocupada', total: novoTotal, itens: comandaTemporaria, cliente: nomeCliente, abertaEm: mesaSelecionada.abertaEm || serverTimestamp() }, { merge: true });
            await batch.commit();
            showNotification(`Mesa ${mesaSelecionada.numero} atualizada!`);
            fecharPdvView();
        };
        
        const setupCozinhaView = () => {
            const container = document.getElementById('cozinha-view');
            container.innerHTML = `
                <div class="h-full flex gap-4 p-4 overflow-x-auto">
                    <div class="bg-gray-800 rounded-lg w-80 flex-shrink-0 flex flex-col">
                        <h2 class="text-xl font-bold p-3 border-b border-gray-700 text-yellow-400">A FAZER</h2>
                        <div id="col-pendente" class="p-3 space-y-3 overflow-y-auto flex-1"></div>
                    </div>
                    <div class="bg-gray-800 rounded-lg w-80 flex-shrink-0 flex flex-col">
                        <h2 class="text-xl font-bold p-3 border-b border-gray-700 text-green-400">AGUARDANDO RETIRADA</h2>
                        <div id="col-pronto" class="p-3 space-y-3 overflow-y-auto flex-1"></div>
                    </div>
                </div>
            `;
            listenToPedidosCozinha();
        };

                                const listenToPedidosCozinha = () => {
            const q = query(collection(db, "pedidos_cozinha"), where("status", "in", ["pendente", "pronto"]));
            
            const unsub = onSnapshot(q, (snapshot) => {
                const colPendente = document.getElementById('col-pendente');
                const colPronto = document.getElementById('col-pronto');
                if(!colPendente || !colPronto) return;

                snapshot.docChanges().forEach(change => {
                    const pedido = { id: change.doc.id, ...change.doc.data() };
                    const cardId = `pedido-${pedido.id}`;
                    const existingCard = document.getElementById(cardId);

                    // Se o pedido foi removido (entregue, cancelado) ou seu status mudou
                    if (change.type === "removed" || (change.type === "modified" && existingCard) ) {
                        if (existingCard) existingCard.remove();
                    }

                    // Adiciona ou move o card para a coluna correta
                    if (pedido.status === 'pendente') {
                        colPendente.appendChild(createPedidoCard(pedido));
                    } else if (pedido.status === 'pronto') {
                        colPronto.appendChild(createPedidoCard(pedido));
                    }

                    // Toca o som apenas quando um novo pedido PENDENTE é adicionado
                    if (change.type === "added" && pedido.status === 'pendente' && synth) {
                        synth.triggerAttackRelease("C5", "0.5");
                    }
                });
                
                // Garante que a ordenação e as mensagens de "nenhum pedido" estejam corretas
                sortCards(colPendente);
                sortCards(colPronto);
                if (colPendente.children.length === 0) colPendente.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum pedido pendente.</p>`;
                if (colPronto.children.length === 0) colPronto.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum pedido pronto.</p>`;

                // Garante que o timer esteja sempre rodando
                if (window.cozinhaTimerInterval) clearInterval(window.cozinhaTimerInterval);
                window.cozinhaTimerInterval = setInterval(updateTimers, 1000);
            });
            listeners.push(unsub);
        };
                    if (!hasPending) colPendente.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum pedido pendente.</p>`;
                    if (!hasReady) colPronto.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum pedido pronto.</p>`;
                }
                
                // CORREÇÃO: Garante que o timer inicie ou continue funcionando
                if (window.cozinhaTimerInterval) clearInterval(window.cozinhaTimerInterval);
                window.cozinhaTimerInterval = setInterval(updateTimers, 1000);
            });
            listeners.push(unsub);
        };
        
        const sortCards = (container) => {
            const cards = Array.from(container.children).filter(c => c.dataset.timestamp);
            cards.sort((a, b) => (a.dataset.timestamp || 0) - (b.dataset.timestamp || 0));
            cards.forEach(card => container.appendChild(card));
        };

                const createPedidoCard = (pedido) => {
            const card = document.createElement('div');
            card.id = `pedido-${pedido.id}`;
            card.dataset.timestamp = pedido.criadoEm?.seconds || 0;
            card.className = 'bg-gray-900 p-3 rounded-lg shadow-lg flex flex-col gap-2 fade-in';
            
            let actionButton;
            if(pedido.status === 'pendente') {
                actionButton = `<button onclick="marcarPedidoPronto('${pedido.id}')" class="w-full mt-2 bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">Pronto</button>`;
            } else {
                actionButton = `<button onclick="marcarPedidoEntregue('${pedido.id}')" class="w-full mt-2 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Entregue</button>`;
            }

            // CORREÇÃO: Adicionado 'pedido.lancadoPor?.nome' e 'pedido.itens?.map'
            // O '?.' (optional chaining) garante que o código não quebre se a informação ainda não chegou.
            card.innerHTML = `
                <div class="flex justify-between items-center pb-1 border-b border-gray-700">
                    <h3 class="text-lg font-extrabold text-amber-400">Mesa ${pedido.mesa}</h3>
                    <span class="text-xs font-bold" data-timestamp="${pedido.criadoEm?.seconds}">00:00</span>
                </div>
                <p class="text-xs text-gray-400">Por: ${pedido.lancadoPor?.nome || 'N/A'}</p>
                <p class="text-sm">${pedido.itens?.map(i => `${i.quantidade}x ${i.nome}`).join(', ') || ''}</p>
                ${actionButton}
            `;
            return card;
        };
        
        const marcarPedidoPronto = id => updateDoc(doc(db, "pedidos_cozinha", id), { status: 'pronto' });
        const marcarPedidoEntregue = id => updateDoc(doc(db, "pedidos_cozinha", id), { status: 'entregue' });

        const setupNotificacaoListener = () => {
            if (!usuarioLogado || usuarioLogado.perfil !== 'atendente') return;
            
            const q = query(collection(db, "pedidos_cozinha"), 
                where("status", "==", "pronto"), 
                where("lancadoPor.uid", "==", usuarioLogado.uid)
            );

            const unsub = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const pedido = change.doc.data();
                        showNotification(`Pedido da Mesa ${pedido.mesa} pronto para retirada!`, 'info', 10000);
                        if (synth) synth.triggerAttackRelease("G5", "0.5");
                    }
                });
            });
            listeners.push(unsub);
        };
        
        const showNotification = (message, type = 'success', duration = 3000) => {
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = `py-3 px-5 rounded-lg shadow-xl text-white fade-in`;
            
            let colorClass = 'bg-green-500';
            if (type === 'error') colorClass = 'bg-red-500';
            if (type === 'info') colorClass = 'bg-blue-500';
            el.classList.add(colorClass);
            
            el.innerHTML = `<p>${message}</p>`;
            container.appendChild(el);

            setTimeout(() => {
                el.classList.add('fade-out');
                el.addEventListener('animationend', () => el.remove());
            }, duration - 500);
        };
        
        const renderCaixaFechadoView = () => { document.getElementById('header-title').textContent = 'Caixa Fechado'; document.getElementById('main-container').innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center p-4"><i class="fas fa-door-closed text-7xl text-gray-500 mb-6"></i><h2 class="text-4xl font-extrabold mb-2">O Caixa está Fechado</h2><p class="text-gray-400 mb-8">Abra o caixa para iniciar as operações do dia.</p><button onclick="abrirModalAberturaCaixa()" class="bg-green-600 text-white font-bold py-4 px-8 rounded-xl text-xl hover:bg-green-700 transition-colors shadow-lg flex items-center gap-3"><i class="fas fa-cash-register"></i> Abrir Caixa</button></div>`; };
        const abrirModalAberturaCaixa = () => { const modal = document.getElementById('abrir-caixa-view'); modal.classList.remove('hidden'); modal.innerHTML = `<div class="bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl p-6 fade-in"><h3 class="text-xl font-bold mb-4">Abrir Caixa</h3><p class="text-sm text-gray-400 mb-4">Digite o valor inicial do caixa (suprimento).</p><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">R$</span><input type="number" id="valor-abertura" class="w-full bg-gray-700 text-white p-3 pl-10 rounded-lg text-lg border-0" placeholder="0,00"></div><div class="grid grid-cols-2 gap-3 mt-6"><button onclick="document.getElementById('abrir-caixa-view').classList.add('hidden')" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button><button onclick="abrirCaixa()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></div>`; document.getElementById('valor-abertura').focus(); };
        const abrirCaixa = async () => { const valor = parseFloat(document.getElementById('valor-abertura').value) || 0; await setDoc(doc(db, "configuracao", "caixa"), { status: 'aberto', valorAbertura: valor, abertoEm: serverTimestamp(), abertoPor: { uid: usuarioLogado.uid, nome: usuarioLogado.nome } }); document.getElementById('abrir-caixa-view').classList.add('hidden'); showNotification(`Caixa aberto com ${formatCurrency(valor)}!`); };
        const fecharCaixa = async () => { if (confirm("Tem certeza que deseja fechar o caixa?")) { await updateDoc(doc(db, "configuracao", "caixa"), { status: 'fechado', fechadoEm: serverTimestamp(), fechadoPor: { uid: usuarioLogado.uid, nome: usuarioLogado.nome } }); showNotification('Caixa fechado!'); } };
        const setupMesasView = () => { const grid = document.getElementById('mesas-grid'); if(!grid) return; grid.innerHTML = ''; for (let i = 1; i <= 50; i++) { const mesaEl = document.createElement('div'); mesaEl.id = `mesa-${i}`; mesaEl.className = 'p-2 rounded-lg text-center cursor-pointer transition-all duration-300'; mesaEl.innerHTML = `<div class="font-extrabold text-3xl">${i}</div><div class="text-xs font-semibold"></div>`; grid.appendChild(mesaEl); } const unsub = onSnapshot(collection(db, "mesas"), snapshot => { let mesasAtivas = new Set(); snapshot.forEach(doc => { updateMesaCard(doc.id, doc.data()); mesasAtivas.add(doc.id); }); for (let i = 1; i <= 50; i++) if (!mesasAtivas.has(String(i))) updateMesaCard(i, { status: 'livre' }); }); listeners.push(unsub); };
        const updateMesaCard = (numero, data) => { const mesaEl = document.getElementById(`mesa-${numero}`); if (!mesaEl) return; const status = data.status || 'livre'; mesaEl.className = 'p-2 rounded-lg text-center cursor-pointer transition-all duration-300'; if (status === 'livre') { mesaEl.classList.add('bg-green-600', 'hover:bg-green-500'); mesaEl.children[1].textContent = 'Livre'; } else { mesaEl.classList.add('bg-red-600', 'hover:bg-red-500'); mesaEl.children[1].innerHTML = `${data.cliente ? `<span class='block text-xs truncate font-normal'>${data.cliente}</span>` : ''}<span class="font-bold">${formatCurrency(data.total || 0)}</span>`; } mesaEl.onclick = () => handleMesaClick(numero, data); };
        const handleMesaClick = async (numero, data) => { if (usuarioLogado.perfil === 'atendente') { abrirPdvView(numero); } else if (usuarioLogado.perfil === 'caixa' && data.status === 'ocupada') { mesaSelecionada = { numero, ...data }; abrirDetalheCaixaView(); } };
        const abrirPdvView = async (numero) => { const mesaDoc = await getDoc(doc(db, "mesas", String(numero))); mesaSelecionada = { numero, ...mesaDoc.data() }; comandaTemporaria = mesaSelecionada.itens ? JSON.parse(JSON.stringify(mesaSelecionada.itens)) : []; document.getElementById('pdv-view').classList.remove('hidden'); renderPdvScreen('adicionar'); };
        const fecharPdvView = () => { const el = document.getElementById('pdv-view'); el.classList.add('hidden'); el.innerHTML = ''; };
        const renderPdvScreen = (screen) => { const container = document.getElementById('pdv-view'); const totalItens = comandaTemporaria.reduce((acc, item) => acc + item.quantidade, 0); container.innerHTML = `<div class="bg-gray-800 w-full h-full flex flex-col fade-in"><header class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0"><h2 class="text-2xl font-bold">Mesa ${mesaSelecionada.numero}</h2></header><main class="flex-1 overflow-y-auto bg-gray-900"></main><footer class="flex-shrink-0 bg-gray-800 border-t border-gray-700 grid grid-cols-3 text-center text-gray-400"><button onclick="renderPdvScreen('conta')" class="p-4 relative ${screen === 'conta' ? 'nav-active' : ''}"><i class="fas fa-receipt text-2xl"></i><span class="text-xs block mt-1">Ver Conta</span>${totalItens > 0 ? `<span class="absolute top-2 right-6 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${totalItens}</span>` : ''}</button><button onclick="renderPdvScreen('adicionar')" class="p-4 ${screen === 'adicionar' ? 'nav-active' : ''}"><i class="fas fa-plus text-2xl"></i><span class="text-xs block mt-1">Adicionar Itens</span></button><button onclick="fecharPdvView()" class="p-4"><i class="fas fa-table-cells text-2xl"></i><span class="text-xs block mt-1">Mesas</span></button></footer></div>`; const main = container.querySelector('main'); if (screen === 'adicionar') { main.innerHTML = `<div class="p-3 border-b border-gray-700 flex-shrink-0 bg-gray-800 sticky top-0 z-10"><div id="categorias-container" class="flex items-center gap-2 overflow-x-auto no-scrollbar"></div></div><div id="produtos-container" class="p-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>`; renderCategorias(); renderProdutos(Object.keys(cardapio)[0]); } else { main.innerHTML = `<div class="p-4 flex flex-col h-full"><div class="mb-4"><label for="cliente-nome" class="text-sm text-gray-400">Nome Cliente</label><input type="text" id="cliente-nome" value="${mesaSelecionada.cliente || ''}" class="w-full bg-gray-700 p-2 rounded-lg mt-1 border-0"></div><h3 class="text-xl font-semibold mb-4">Comanda</h3><div id="comanda-itens" class="flex-1 space-y-2 overflow-y-auto no-scrollbar pr-2 mb-4"></div><div class="border-t border-gray-700 pt-4"><div class="flex justify-between items-center text-2xl font-bold mb-4"><span>Total</span><span id="comanda-total">R$ 0,00</span></div><button onclick="enviarPedido()" class="w-full bg-green-600 font-bold py-3 rounded-lg"><i class="fas fa-paper-plane"></i> Salvar & Enviar</button></div></div>`; renderComanda(); } };
        const renderCategorias = () => { const container = document.getElementById('categorias-container'); container.innerHTML = ''; Object.keys(cardapio).forEach((cat, i) => { const btn = document.createElement('button'); btn.textContent = cat; btn.className = `py-2 px-4 rounded-full font-semibold text-sm whitespace-nowrap ${i === 0 ? 'bg-amber-500 text-white' : 'bg-gray-700'}`; btn.onclick = () => { renderProdutos(cat); container.querySelectorAll('button').forEach(b => b.className = 'py-2 px-4 rounded-full font-semibold text-sm whitespace-nowrap bg-gray-700'); btn.className = 'py-2 px-4 rounded-full font-semibold text-sm whitespace-nowrap bg-amber-500 text-white'; }; container.appendChild(btn); }); };
        const renderProdutos = (cat) => { const container = document.getElementById('produtos-container'); container.innerHTML = ''; cardapio[cat].forEach(item => { const card = document.createElement('div'); card.className = "bg-gray-700 p-3 rounded-lg cursor-pointer"; card.innerHTML = `<p class="font-semibold">${item.nome}</p><p class="text-lg text-amber-400 font-bold mt-2">${formatCurrency(item.preco)}</p>`; card.onclick = () => abrirDetalhesItem(item); container.appendChild(card); }); };
                const abrirDetalhesItem = (item) => {
            const container = document.getElementById('item-details-view');
            container.classList.remove('hidden');
            container.innerHTML = `<div class="bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl flex flex-col fade-in"><header class="p-4 border-b border-gray-700"><h3 class="text-xl font-bold">${item.nome}</h3>${item.description ? `<p class="text-sm text-gray-400">${item.description}</p>` : ''}</header><div class="p-4 space-y-4"><div class="flex items-center justify-center gap-4"><button id="d-minus" class="bg-gray-600 w-10 h-10 rounded-full font-bold text-xl">-</button><span id="d-qty" class="font-bold text-2xl w-10 text-center">1</span><button id="d-plus" class="bg-gray-600 w-10 h-10 rounded-full font-bold text-xl">+</button></div><textarea id="d-obs" class="w-full bg-gray-700 p-2 rounded-lg h-20" placeholder="Obs: Sem cebola..."></textarea></div><footer class="p-4 border-t border-gray-700 grid grid-cols-2 gap-3"><button onclick="fecharDetalhesItem()" class="bg-gray-600 font-bold py-2 rounded-lg">Cancelar</button><button id="d-confirm" class="bg-amber-600 font-bold py-2 rounded-lg">Confirmar</button></footer></div>`;
            
            let qty = 1;
            const qtyEl = container.querySelector('#d-qty');
            container.querySelector('#d-minus').onclick = () => { if(qty > 1) qtyEl.textContent = --qty; };
            container.querySelector('#d-plus').onclick = () => qtyEl.textContent = ++qty;
            container.querySelector('#d-confirm').onclick = () => {
                const obs = container.querySelector('#d-obs').value.trim();
                const itemExistente = comandaTemporaria.find(i => i.id === item.id && i.observacao === obs);
                if (itemExistente) {
                    itemExistente.quantidade += qty;
                } else {
                    comandaTemporaria.push({ ...item, quantidade: qty, observacao: obs });
                }
                showNotification(`${qty}x ${item.nome} adicionado!`);
                fecharDetalhesItem();
                
                // CORREÇÃO: Alterado de 'conta' para 'adicionar'
                // Isso faz o atendente permanecer na mesma tela.
                renderPdvScreen('adicionar');
            }; 
        };
        const fecharDetalhesItem = () => document.getElementById('item-details-view').classList.add('hidden');
        const renderComanda = () => { const container = document.getElementById('comanda-itens'); const totalEl = document.getElementById('comanda-total'); if(!container || !totalEl) return; let total = 0; container.innerHTML = ''; if(comandaTemporaria.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">Nenhum item.</p>'; totalEl.textContent = formatCurrency(0); return; } comandaTemporaria.forEach((item, i) => { total += item.preco * item.quantidade; const itemDiv = document.createElement('div'); itemDiv.className = "flex justify-between items-center bg-gray-700/50 p-2 rounded"; itemDiv.innerHTML = `<div><p>${item.nome}</p>${item.observacao ? `<p class="text-xs text-amber-400">Obs: ${item.observacao}</p>` : ''}</div><div class="flex items-center gap-3"><button onclick="changeQty(${i}, -1)">-</button><span>${item.quantidade}</span><button onclick="changeQty(${i}, 1)">+</button></div>`; container.appendChild(itemDiv); }); totalEl.textContent = formatCurrency(total); };
        const changeQty = (i, amount) => { if(comandaTemporaria[i]) { comandaTemporaria[i].quantidade += amount; if (comandaTemporaria[i].quantidade <= 0) comandaTemporaria.splice(i, 1); } renderComanda(); };
                const updateTimers = () => {
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                const timestamp = parseInt(el.dataset.timestamp, 10);
                if (!timestamp) return;
                
                const diff = Math.floor(Date.now() / 1000) - timestamp;
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                
                el.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                el.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500');

                // LÓGICA DE COR CORRIGIDA
                if (minutes >= 35) {
                    el.classList.add('text-red-500');
                } else if (minutes >= 25) {
                    el.classList.add('text-yellow-400');
                } else {
                    el.classList.add('text-green-400');
                }
            });
        };
 /* Lógica de relatórios mantida como antes */ }; const fecharRelatoriosView = () => document.getElementById('relatorios-view').classList.add('hidden');
        const fecharDetalheCaixaView = () => document.getElementById('caixa-detalhe-view').classList.add('hidden');
        const formatCurrency = v => v ? v.toLocaleString('pt-BR', { style: 'currency', 'currency': 'BRL' }) : 'R$ 0,00';

        // Expondo as funções necessárias globalmente
        window.handleLogout = handleLogout; window.abrirGestaoUsuariosView = abrirGestaoUsuariosView; window.toggleUserStatus = toggleUserStatus; window.fecharConta = fecharConta; window.cancelarPedidosMesa = cancelarPedidosMesa; window.marcarPedidoPronto = marcarPedidoPronto; window.marcarPedidoEntregue = marcarPedidoEntregue; window.abrirModalAberturaCaixa=abrirModalAberturaCaixa; window.abrirCaixa=abrirCaixa; window.fecharCaixa=fecharCaixa; window.fecharPdvView=fecharPdvView; window.renderPdvScreen=renderPdvScreen; window.enviarPedido=enviarPedido; window.changeQty=changeQty; window.fecharDetalhesItem=fecharDetalhesItem; window.fecharDetalheCaixaView=fecharDetalheCaixaView; window.handleCriarUsuario = handleCriarUsuario;
        
        initFirebase();
    </script>
</body>
</html>
